<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DigitMart BillBook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap'); /* Thermal Font */
        
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* --- MODERN A4 INVOICE (Hidden, used for JPG Capture) --- */
        #invoice-modern-render {
            width: 794px; /* A4 Width in px approx */
            min-height: 1123px;
            background: white;
            position: fixed;
            top: 0;
            left: -9999px; /* Hidden from view */
            z-index: -1;
        }

        .fab-shadow { box-shadow: 0 4px 15px rgba(23, 114, 230, 0.4); }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .badge-paid { background-color: #dcfce7; color: #166534; font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 700; letter-spacing: 0.5px; }
        .filter-active { background-color: #0088cc; color: white; border-color: #0088cc; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 select-none bg-slate-100">

    <!-- LOGIN SCREEN -->
    <div id="view-login" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 hidden">
        <div class="w-20 h-20 bg-blue-700 rounded-xl flex items-center justify-center text-white text-3xl font-bold mb-4 shadow-lg">DM</div>
        <h1 class="text-2xl font-bold text-slate-800 mb-1">DigitMart</h1>
        <p class="text-slate-500 mb-8 text-sm">Business Management</p>
        <div class="w-full max-w-xs space-y-4">
            <div id="login-shop-display" class="text-center font-bold text-lg text-blue-700 hidden"></div>
            <input type="password" id="input-pass" placeholder="Password" class="w-full p-3 border border-slate-300 rounded-lg text-center text-lg outline-none focus:border-blue-600 bg-slate-50">
            <button onclick="app.login()" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-3 rounded-lg font-bold shadow-md active:scale-95 transition">OPEN</button>
        </div>
        <div class="absolute bottom-6 text-xs text-slate-400">Powered by <b>DigitMart</b></div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="view-setup" class="fixed inset-0 z-50 bg-slate-100 flex flex-col items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl">
            <h2 class="text-xl font-bold mb-4 text-center text-slate-800">Setup Shop</h2>
            <form onsubmit="app.saveSetup(event)" class="space-y-3">
                <input name="shopName" placeholder="Shop Name" required class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="address" placeholder="Address" required class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="phone" placeholder="Phone No" required type="number" class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="upi" placeholder="UPI ID (e.g. 98xxx@ybl)" class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="gstin" placeholder="Shop GSTIN (Optional)" class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="password" placeholder="Set Password" required type="password" class="w-full p-3 border border-blue-200 rounded-lg bg-blue-50 outline-none focus:border-blue-500 font-bold">
                <button type="submit" class="w-full bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg mt-2">START</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="app-interface" class="flex-1 flex flex-col h-full hidden">
        
        <!-- HEADER -->
        <div class="bg-[#006699] px-4 py-3 shadow-md sticky top-0 z-30 flex justify-between items-center text-white">
            <div class="flex items-center gap-3">
                <button id="back-btn" onclick="app.nav('dashboard')" class="hidden w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div>
                    <h1 id="header-shop-name" class="font-bold text-lg tracking-wide leading-none">DigitMart</h1>
                    <p class="text-[9px] opacity-80">BillBook Pro</p>
                </div>
            </div>
            <div class="flex gap-4 text-white/90">
                <i class="fa-solid fa-bullhorn cursor-pointer"></i>
                <i class="fa-solid fa-bell cursor-pointer"></i>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <div class="flex-1 overflow-y-auto bg-slate-100 relative p-3" id="main-content">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="space-y-4 pb-24 fade-in">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-[#e8f5e9] p-4 rounded-lg shadow-sm border border-green-100 flex flex-col justify-between h-24">
                        <span class="text-sm font-semibold text-slate-700">Total Sales</span>
                        <h2 class="text-xl font-bold text-green-600">₹ <span id="dash-total">0</span></h2>
                    </div>
                    <div class="bg-[#ffebee] p-4 rounded-lg shadow-sm border border-red-100 flex flex-col justify-between h-24">
                        <span class="text-sm font-semibold text-slate-700">My Expenses</span>
                        <h2 class="text-xl font-bold text-red-600">₹ <span id="dash-expense">0</span></h2>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.nav('history')" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition h-32">
                        <i class="fa-solid fa-file-invoice text-3xl text-[#0088cc]"></i>
                        <span class="text-sm font-semibold text-slate-600">Sale List</span>
                    </button>
                    <button onclick="app.nav('items')" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition h-32">
                        <i class="fa-solid fa-cart-shopping text-3xl text-[#0088cc]"></i>
                        <span class="text-sm font-semibold text-slate-600">Items</span>
                    </button>
                    <button onclick="app.nav('expenses')" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition h-32">
                        <i class="fa-solid fa-wallet text-3xl text-[#0088cc]"></i>
                        <span class="text-sm font-semibold text-slate-600">Expenses</span>
                    </button>
                    <button onclick="app.nav('settings')" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition h-32">
                        <i class="fa-solid fa-sliders text-3xl text-[#0088cc]"></i>
                        <span class="text-sm font-semibold text-slate-600">Settings</span>
                    </button>
                </div>
                
                <div class="text-center mt-8">
                    <p class="text-[10px] text-slate-400">Powered by <span class="font-bold text-slate-500">DigitMart</span></p>
                </div>
            </div>

            <!-- NEW SALE SCREEN -->
            <div id="view-billing" class="hidden h-full flex flex-col fade-in">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex-1 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <span class="text-xs font-bold text-slate-500">Invoice No</span>
                        <span class="font-mono font-bold text-slate-800" id="bill-inv-no">#INV-0000</span>
                    </div>
                    <div class="mb-4 space-y-3">
                        <input id="bill-cust-name" placeholder="Customer Name (Optional)" class="w-full p-2 border-b border-slate-200 outline-none text-sm bg-transparent focus:border-blue-500 transition font-semibold">
                        <input id="bill-cust-phone" type="number" placeholder="Customer Phone (Optional)" class="w-full p-2 border-b border-slate-200 outline-none text-sm bg-transparent focus:border-blue-500 transition font-semibold">
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Item Name</label>
                            <input id="bill-item-name" list="item-suggestions" oninput="app.checkItemPrice()" placeholder="Enter Item Name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none font-semibold text-slate-700">
                            <datalist id="item-suggestions"></datalist>
                        </div>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-xs font-bold text-slate-400 uppercase">Price</label>
                                <input id="bill-amount" type="number" placeholder="₹ Rate" class="w-full p-3 bg-blue-50 border border-blue-200 rounded-lg outline-none text-xl font-bold text-blue-800" onkeyup="app.calculateTotal()">
                            </div>
                            <div class="w-24">
                                <label class="text-xs font-bold text-slate-400 uppercase">GST %</label>
                                <select id="bill-gst" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none font-bold text-slate-700" onchange="app.calculateTotal()">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="12">12%</option>
                                    <option value="18">18%</option>
                                    <option value="28">28%</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex justify-between items-center">
                             <span class="text-sm font-bold text-slate-500">Total with GST:</span>
                             <span class="text-xl font-bold text-green-600">₹ <span id="bill-final-total">0.00</span></span>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Payment Type</label>
                            <div class="grid grid-cols-3 gap-2 bg-slate-100 p-1 rounded-lg">
                                <button onclick="app.setMode('Cash')" id="mode-Cash" class="mode-btn py-2 rounded-md text-sm font-bold bg-white text-blue-700 shadow-sm transition">Cash</button>
                                <button onclick="app.setMode('UPI')" id="mode-UPI" class="mode-btn py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition">UPI</button>
                                <button onclick="app.setMode('Credit')" id="mode-Credit" class="mode-btn py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition">Credit</button>
                            </div>
                        </div>
                        <div id="live-qr-container" class="hidden flex flex-col items-center justify-center p-4 bg-white border-2 border-dashed border-blue-200 rounded-xl">
                            <div id="live-qrcode"></div>
                            <p class="text-[10px] text-slate-400 mt-2">Scan to Pay</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-3 pb-16">
                    <button onclick="app.saveBill(true)" class="bg-slate-700 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition">Save & New</button>
                    <button onclick="app.saveBill(false)" class="bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition">Save</button>
                </div>
            </div>

            <!-- EXPENSES, ITEMS, HISTORY -->
            <div id="view-expenses" class="hidden fade-in pb-20">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">Add Expense</h3>
                    <div class="flex gap-2 mb-2">
                        <input id="exp-name" placeholder="Name" class="flex-1 p-2 border rounded-lg outline-none text-sm">
                        <input id="exp-amt" type="number" placeholder="₹" class="w-24 p-2 border rounded-lg outline-none text-sm font-bold">
                    </div>
                    <button onclick="app.addExpense()" class="w-full bg-red-500 text-white py-2 rounded-lg font-bold text-sm shadow-sm">Add Expense</button>
                </div>
                <div id="expense-list" class="space-y-2"></div>
            </div>

            <div id="view-items" class="hidden fade-in pb-20">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">Add Stock Item</h3>
                    <div class="flex gap-2">
                        <div class="flex-1 space-y-2">
                            <input id="stock-name" placeholder="Item" class="w-full p-2 border rounded-lg outline-none text-sm">
                            <input id="stock-price" type="number" placeholder="₹" class="w-full p-2 border rounded-lg outline-none text-sm">
                        </div>
                        <button onclick="app.addStockItem()" class="bg-blue-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm">Add</button>
                    </div>
                </div>
                <div id="stock-list" class="space-y-2"></div>
            </div>

            <div id="view-history" class="hidden pb-20 fade-in bg-[#f0f4f8]">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100">
                        <span class="text-xs text-slate-500 font-semibold">Total Sale</span>
                        <h2 class="text-lg font-bold text-slate-800">₹ <span id="hist-total">0.00</span></h2>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100">
                        <span class="text-xs text-slate-500 font-semibold">Balance Due</span>
                        <h2 class="text-lg font-bold text-red-500">₹ 0.00</h2>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 mb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Last 7 Days Trend</h3>
                    <div class="h-32 w-full"><canvas id="salesChart"></canvas></div>
                </div>
                <div class="flex bg-white p-1 rounded-lg mb-4 shadow-sm border border-slate-100">
                    <button onclick="app.filterHistory('today')" id="btn-today" class="flex-1 py-1.5 text-xs font-bold rounded transition-all filter-active">Today</button>
                    <button onclick="app.filterHistory('month')" id="btn-month" class="flex-1 py-1.5 text-xs font-bold rounded transition-all text-slate-500">This Month</button>
                    <button onclick="app.filterHistory('all')" id="btn-all" class="flex-1 py-1.5 text-xs font-bold rounded transition-all text-slate-500">All</button>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>

            <div id="view-settings" class="hidden pb-20 fade-in">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 space-y-4">
                    <h2 class="font-bold border-b pb-2">Settings</h2>
                    <input id="set-name" placeholder="Shop Name" class="w-full p-2 border rounded outline-none text-sm">
                    <input id="set-upi" placeholder="UPI ID" class="w-full p-2 border rounded outline-none text-sm">
                    <input id="set-phone" placeholder="Phone" class="w-full p-2 border rounded outline-none text-sm">
                    <input id="set-address" placeholder="Address" class="w-full p-2 border rounded outline-none text-sm">
                    <input id="set-gstin" placeholder="GSTIN" class="w-full p-2 border rounded outline-none text-sm">
                    <button onclick="app.updateProfile()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold shadow">Update</button>
                    
                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <button onclick="app.exportExcel()" class="bg-green-100 text-green-700 py-2 rounded-lg font-bold border border-green-200 text-xs flex flex-col items-center justify-center gap-1"><i class="fa-solid fa-file-excel text-lg"></i> Excel Backup</button>
                        <button onclick="app.backupFlow()" class="bg-blue-100 text-blue-700 py-2 rounded-lg font-bold border border-blue-200 text-xs flex flex-col items-center justify-center gap-1"><i class="fa-solid fa-download text-lg"></i> JSON Backup</button>
                    </div>
                    <label class="block bg-slate-100 text-slate-700 py-3 rounded-lg font-bold border-2 border-dashed border-slate-300 text-sm text-center cursor-pointer hover:bg-slate-200 transition mt-4">
                        <i class="fa-solid fa-upload mr-2"></i> Restore Data (Excel / JSON)
                        <input type="file" class="hidden" onchange="app.restore(this)" accept=".json,.xlsx,.xls">
                    </label>

                    <!-- Share DigitTools Button -->
                    <button onclick="app.shareDigitTools()" class="w-full bg-indigo-100 text-indigo-700 py-3 rounded-lg font-bold border border-indigo-200 text-sm mt-4 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-share-nodes"></i> Share DigitTools (DigitPhone)
                    </button>

                    <button onclick="app.logout()" class="w-full text-red-500 py-2 font-bold text-xs mt-2">Logout</button>
                </div>
            </div>
        </div>

        <!-- FAB -->
        <div id="fab-btn" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-40">
            <button onclick="app.newBill()" class="w-14 h-14 bg-[#0088cc] rounded-full text-white text-2xl shadow-xl fab-shadow flex items-center justify-center border-4 border-white active:scale-90 transition">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- SUCCESS MODAL -->
    <div id="success-modal" class="fixed inset-0 z-[60] bg-black/80 flex flex-col items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-xl w-[300px] text-center mb-4">
             <i class="fa-solid fa-circle-check text-5xl text-green-500 mb-2"></i>
             <h2 class="text-xl font-bold">Saved!</h2>
             <p class="text-sm text-slate-500 mb-4">What next?</p>
             <div class="flex gap-4 justify-center flex-wrap">
                 <button onclick="app.downloadBillAction()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center text-sm active:scale-95 transition">
                    <i class="fa-solid fa-download mr-1"></i> Download
                 </button>
                 <button onclick="app.shareBillAction()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center text-sm active:scale-95 transition">
                    <i class="fa-brands fa-whatsapp mr-1"></i> Share
                 </button>
             </div>
             <button onclick="document.getElementById('success-modal').classList.add('hidden')" class="text-slate-400 text-xs font-bold mt-4 underline">Close</button>
        </div>
    </div>

    <!-- 2. MODERN A4 INVOICE (Hidden, for JPG Capture) -->
    <div id="invoice-modern-render" class="p-8 text-slate-800 font-sans">
        <!-- Header -->
        <div class="bg-[#003366] text-white p-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold" id="mod-shop-name">SHOP NAME</h1>
                <p class="text-sm mt-1 opacity-80">INVOICE</p>
            </div>
            <div class="text-right">
                <h2 class="text-2xl font-bold" id="mod-inv-total">₹ 0.00</h2>
            </div>
        </div>

        <div class="p-8">
            <!-- Info Grid -->
            <div class="flex justify-between mb-8">
                <div class="w-1/2">
                    <p class="text-xs font-bold text-slate-400 uppercase">From</p>
                    <p class="font-bold" id="mod-from-name">Shop Name</p>
                    <p class="text-sm text-slate-600" id="mod-from-addr">Address</p>
                    <p class="text-sm text-slate-600" id="mod-from-phone">Phone</p>
                    <p class="text-sm text-slate-600">GSTIN: <span id="mod-from-gst"></span></p>
                </div>
                <div class="w-1/2 text-right">
                    <p class="text-xs font-bold text-slate-400 uppercase">Bill To</p>
                    <p class="font-bold" id="mod-to-name">Guest</p>
                    <p class="text-sm text-slate-600" id="mod-to-phone">Phone</p>
                    <div class="mt-4">
                        <p class="text-sm"><span class="font-bold">Invoice #:</span> <span id="mod-inv-no"></span></p>
                        <p class="text-sm"><span class="font-bold">Date:</span> <span id="mod-inv-date"></span></p>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <table class="w-full mb-8">
                <thead class="bg-[#003366] text-white">
                    <tr>
                        <th class="p-3 text-left text-sm">DESCRIPTION</th>
                        <th class="p-3 text-center text-sm">QTY</th>
                        <th class="p-3 text-center text-sm">PRICE</th>
                        <th class="p-3 text-center text-sm">GST</th>
                        <th class="p-3 text-right text-sm">AMOUNT</th>
                    </tr>
                </thead>
                <tbody id="mod-tbody" class="text-sm text-slate-700">
                    <!-- Row -->
                </tbody>
            </table>

            <!-- Totals -->
            <div class="flex justify-end">
                <div class="w-64">
                    <div class="flex justify-between py-1 border-b">
                        <span class="text-slate-500">Subtotal</span>
                        <span id="mod-subtotal">0.00</span>
                    </div>
                    <div class="flex justify-between py-1 border-b">
                        <span class="text-slate-500">Tax (GST)</span>
                        <span id="mod-tax">0.00</span>
                    </div>
                    <div class="flex justify-between py-2 font-bold text-lg text-[#003366]">
                        <span>TOTAL</span>
                        <span>₹ <span id="mod-grand-total">0.00</span></span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-16 pt-8 border-t text-center text-xs text-slate-400">
                <p>Thank you for your business!</p>
                <p class="mt-1">Payment Info: UPI - <span id="mod-upi"></span></p>
                <p class="mt-4 font-bold text-slate-300">Powered by DigitMart</p>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = 'digitmart_billbook_v10'; 
        let salesChartInstance = null;

        const app = {
            data: { shop: null, invoices: [], expenses: [], items: [] }, 
            currentMode: 'Cash',
            currentInv: null,

            init: function() {
                const stored = localStorage.getItem(DB_KEY);
                if(stored) {
                    this.data = JSON.parse(stored);
                    if(this.data.items.length > 0 && typeof this.data.items[0] === 'string') {
                        this.data.items = this.data.items.map(name => ({name, price: ''}));
                    }
                }
                if(this.data.shop) {
                    document.getElementById('view-login').classList.remove('hidden');
                    document.getElementById('login-shop-display').innerText = this.data.shop.shopName;
                    document.getElementById('login-shop-display').classList.remove('hidden');
                } else {
                    document.getElementById('view-setup').classList.remove('hidden');
                }
            },

            save: function() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                this.updateDashboard();
            },

            saveSetup: function(e) {
                e.preventDefault();
                const fd = new FormData(e.target);
                this.data.shop = Object.fromEntries(fd.entries());
                this.save();
                location.reload();
            },

            login: function() {
                if(document.getElementById('input-pass').value === this.data.shop.password) {
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('app-interface').classList.remove('hidden');
                    this.loadSettings();
                    this.nav('dashboard');
                } else alert('Wrong Password');
            },

            logout: function() { location.reload(); },

            nav: function(viewId) {
                document.querySelectorAll('#main-content > div').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + viewId).classList.remove('hidden');
                document.getElementById('header-shop-name').innerText = this.data.shop.shopName;
                const fab = document.getElementById('fab-btn');
                const backBtn = document.getElementById('back-btn');

                if(viewId === 'dashboard') {
                    fab.classList.remove('hidden');
                    backBtn.classList.add('hidden');
                    this.updateDashboard();
                } else {
                    fab.classList.add('hidden');
                    backBtn.classList.remove('hidden');
                }
                if(viewId === 'billing') {
                    document.getElementById('bill-inv-no').innerText = `INV-${String(this.data.invoices.length + 1).padStart(4, '0')}`;
                    this.populateItemSuggestions();
                }
                if(viewId === 'history') { this.filterHistory('today'); this.renderSalesChart(); }
                if(viewId === 'expenses') this.renderExpenses();
                if(viewId === 'items') this.renderStockItems();
            },

            updateDashboard: function() {
                const totalSale = this.data.invoices.reduce((sum, i) => sum + parseFloat(i.grandTotal), 0);
                const totalExp = this.data.expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
                document.getElementById('dash-total').innerText = totalSale.toLocaleString('en-IN');
                document.getElementById('dash-expense').innerText = totalExp.toLocaleString('en-IN');
            },

            newBill: function() {
                this.currentMode = 'Cash';
                this.updateModeUI();
                document.getElementById('bill-cust-name').value = '';
                document.getElementById('bill-item-name').value = '';
                document.getElementById('bill-amount').value = '';
                document.getElementById('bill-cust-phone').value = '';
                document.getElementById('bill-gst').value = '0';
                document.getElementById('bill-final-total').innerText = '0.00';
                document.getElementById('live-qr-container').classList.add('hidden');
                this.nav('billing');
            },

            setMode: function(mode) {
                this.currentMode = mode;
                this.updateModeUI();
                this.calculateTotal(); 
            },

            updateModeUI: function() {
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.className = "mode-btn py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition";
                });
                document.getElementById('mode-' + this.currentMode).className = "mode-btn py-2 rounded-md text-sm font-bold bg-white text-blue-700 shadow-sm transition ring-1 ring-blue-100";
            },

            checkItemPrice: function() {
                const val = document.getElementById('bill-item-name').value;
                const item = this.data.items.find(i => i.name === val);
                if(item && item.price) {
                    document.getElementById('bill-amount').value = item.price;
                    this.calculateTotal();
                }
            },

            calculateTotal: function() {
                const price = parseFloat(document.getElementById('bill-amount').value) || 0;
                const gstRate = parseFloat(document.getElementById('bill-gst').value) || 0;
                const taxAmt = (price * gstRate) / 100;
                const total = price + taxAmt;
                document.getElementById('bill-final-total').innerText = total.toFixed(2);
                const qrCont = document.getElementById('live-qr-container');
                const qrDiv = document.getElementById('live-qrcode');
                if(this.currentMode === 'UPI' && total > 0 && this.data.shop.upi) {
                    qrCont.classList.remove('hidden');
                    qrDiv.innerHTML = '';
                    const link = `upi://pay?pa=${this.data.shop.upi}&pn=${encodeURIComponent(this.data.shop.shopName)}&am=${total.toFixed(2)}&cu=INR`;
                    new QRCode(qrDiv, { text: link, width: 120, height: 120 });
                } else {
                    qrCont.classList.add('hidden');
                }
                return { price, gstRate, taxAmt, total };
            },

            saveBill: function(isNew) {
                const calcs = this.calculateTotal();
                if(!calcs.price || calcs.price <= 0) return alert('Boss, Price to daalo!');
                
                const inv = {
                    id: Date.now(),
                    no: `INV-${String(this.data.invoices.length + 1).padStart(4, '0')}`,
                    date: new Date().toLocaleDateString('en-IN'),
                    rawDate: new Date(),
                    time: new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}),
                    item: document.getElementById('bill-item-name').value || 'Sale',
                    rate: calcs.price,
                    gstPercent: calcs.gstRate,
                    taxAmount: calcs.taxAmt,
                    grandTotal: calcs.total.toFixed(2),
                    mode: this.currentMode,
                    phone: document.getElementById('bill-cust-phone').value,
                    name: document.getElementById('bill-cust-name').value || 'Guest'
                };

                this.data.invoices.unshift(inv);
                this.save();
                this.currentInv = inv;

                if(isNew) {
                    const btn = event.target;
                    const originalText = btn.innerText;
                    btn.innerText = "Saved!";
                    btn.classList.replace('bg-slate-700', 'bg-green-600');
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.classList.replace('bg-green-600', 'bg-slate-700');
                        this.newBill();
                    }, 800);
                } else {
                    document.getElementById('success-modal').classList.remove('hidden');
                }
            },

            // --- UPDATED: DOWNLOAD & SHARE ONLY ---
            prepareInvoices: function(inv) {
                document.getElementById('mod-shop-name').innerText = this.data.shop.shopName;
                document.getElementById('mod-inv-total').innerText = `₹ ${inv.grandTotal}`;
                document.getElementById('mod-from-name').innerText = this.data.shop.shopName;
                document.getElementById('mod-from-addr').innerText = this.data.shop.address;
                document.getElementById('mod-from-phone').innerText = this.data.shop.phone;
                document.getElementById('mod-from-gst').innerText = this.data.shop.gstin || 'N/A';
                document.getElementById('mod-to-name').innerText = inv.name;
                document.getElementById('mod-to-phone').innerText = inv.phone || '-';
                document.getElementById('mod-inv-no').innerText = inv.no;
                document.getElementById('mod-inv-date').innerText = inv.date;
                document.getElementById('mod-tbody').innerHTML = `
                    <tr class="border-b">
                        <td class="p-3">${inv.item}</td>
                        <td class="p-3 text-center">1</td>
                        <td class="p-3 text-center">${inv.rate}</td>
                        <td class="p-3 text-center">${inv.gstPercent}%</td>
                        <td class="p-3 text-right font-bold">${inv.grandTotal}</td>
                    </tr>`;
                document.getElementById('mod-subtotal').innerText = inv.rate;
                document.getElementById('mod-tax').innerText = parseFloat(inv.taxAmount).toFixed(2);
                document.getElementById('mod-grand-total').innerText = inv.grandTotal;
                document.getElementById('mod-upi').innerText = this.data.shop.upi || 'N/A';
            },

            downloadModernJPG: function(cb) {
                const el = document.getElementById('invoice-modern-render');
                html2canvas(el, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Invoice_${this.currentInv.no}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    if(cb) cb();
                });
            },

            downloadBillAction: function() {
                if(!this.currentInv) return;
                this.prepareInvoices(this.currentInv);
                this.downloadModernJPG();
            },

            shareBillAction: function() {
                if(!this.currentInv) return;
                if(!this.currentInv.phone) return alert('No Customer Phone!');
                this.prepareInvoices(this.currentInv);
                this.downloadModernJPG(() => {
                    const text = `*INVOICE FROM ${this.data.shop.shopName}*\n\nBill No: ${this.currentInv.no}\nAmount: ₹${this.currentInv.grandTotal}\n\nPlease find the attached invoice image.\nThank You!`;
                    window.open(`https://wa.me/91${this.currentInv.phone}?text=${encodeURIComponent(text)}`, '_blank');
                });
            },

            addExpense: function() {
                const name = document.getElementById('exp-name').value;
                const amt = parseFloat(document.getElementById('exp-amt').value);
                if(!name || !amt) return;
                this.data.expenses.unshift({ id: Date.now(), name, amount: amt, date: new Date().toLocaleDateString('en-IN') });
                this.save();
                document.getElementById('exp-name').value = '';
                document.getElementById('exp-amt').value = '';
                this.renderExpenses();
            },

            renderExpenses: function() {
                const list = document.getElementById('expense-list');
                list.innerHTML = '';
                this.data.expenses.forEach(e => {
                    list.innerHTML += `<div class="bg-white p-3 rounded-lg border flex justify-between"><span class="text-sm font-semibold">${e.name} <span class="text-xs text-slate-400">(${e.date})</span></span><span class="font-bold text-red-500">₹${e.amount}</span></div>`;
                });
            },

            addStockItem: function() {
                const name = document.getElementById('stock-name').value;
                const price = document.getElementById('stock-price').value;
                if(!name) return;
                this.data.items.push({name, price});
                this.save();
                document.getElementById('stock-name').value = '';
                document.getElementById('stock-price').value = '';
                this.renderStockItems();
            },

            renderStockItems: function() {
                const list = document.getElementById('stock-list');
                list.innerHTML = '';
                this.data.items.forEach(i => {
                    list.innerHTML += `<div class="bg-white p-3 rounded-lg border text-sm font-semibold text-slate-700 flex justify-between"><span>${i.name}</span><span class="text-blue-600 font-bold">₹${i.price || '-'}</span></div>`;
                });
            },
            
            populateItemSuggestions: function() {
                const dl = document.getElementById('item-suggestions');
                dl.innerHTML = '';
                this.data.items.forEach(i => { dl.innerHTML += `<option value="${i.name}">`; });
            },

            filterHistory: function(type) {
                ['btn-today', 'btn-month', 'btn-all'].forEach(id => {
                    document.getElementById(id).className = "flex-1 py-1.5 text-xs font-bold rounded transition-all text-slate-500";
                });
                document.getElementById('btn-'+type).className = "flex-1 py-1.5 text-xs font-bold rounded transition-all filter-active";
                const todayStr = new Date().toLocaleDateString('en-IN');
                const now = new Date();
                let filtered = [];
                if(type === 'today') filtered = this.data.invoices.filter(i => i.date === todayStr);
                else if(type === 'month') filtered = this.data.invoices.filter(i => {
                    const d = new Date(i.rawDate || i.id);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                else filtered = this.data.invoices;

                document.getElementById('hist-total').innerText = filtered.reduce((sum, i) => sum + parseFloat(i.grandTotal), 0).toLocaleString('en-IN', {minimumFractionDigits: 2});
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                if(filtered.length === 0) { list.innerHTML = '<div class="text-center text-slate-400 py-6 text-xs">No records found</div>'; return; }

                filtered.forEach(i => {
                    list.innerHTML += `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="flex items-center gap-2 mb-1"><h4 class="font-bold text-slate-800">${i.mode} Sale</h4><span class="badge-paid">PAID</span></div>
                                    <h2 class="text-xl font-bold text-slate-900">₹ ${i.grandTotal}</h2>
                                    <p class="text-[10px] text-slate-400 mt-1">GST: ${i.gstPercent}%</p>
                                </div>
                                <div class="text-right"><div class="text-[10px] text-slate-400">Sale #${i.no}</div><div class="text-[10px] text-slate-400">${i.date}</div></div>
                            </div>
                            <div class="border-t border-slate-100 pt-3 flex justify-end gap-4 text-slate-500">
                                <button onclick="app.currentInv=app.data.invoices.find(x=>x.id==${i.id});app.downloadBillAction()" class="hover:text-blue-600"><i class="fa-solid fa-download text-lg"></i></button>
                                <button onclick="app.currentInv=app.data.invoices.find(x=>x.id==${i.id});app.shareBillAction()" class="hover:text-green-600"><i class="fa-brands fa-whatsapp text-lg"></i></button>
                                <button onclick="app.deleteInvoice(${i.id})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash text-lg"></i></button>
                            </div>
                        </div>`;
                });
            },

            deleteInvoice: function(id) {
                if(confirm('Delete kar dun Boss?')) {
                    this.data.invoices = this.data.invoices.filter(i => i.id !== id);
                    this.save();
                    this.filterHistory('today');
                    this.renderSalesChart();
                }
            },

            renderSalesChart: function() {
                const labels = [], data = [], today = new Date();
                for(let i=6; i>=0; i--) {
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    const dateStr = d.toLocaleDateString('en-IN');
                    labels.push(dateStr.slice(0, 5));
                    data.push(this.data.invoices.filter(inv => inv.date === dateStr).reduce((sum, inv) => sum + parseFloat(inv.grandTotal), 0));
                }
                const ctx = document.getElementById('salesChart').getContext('2d');
                if(salesChartInstance) salesChartInstance.destroy();
                salesChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Sales', data, backgroundColor: '#0088cc', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
            },

            loadSettings: function() {
                document.getElementById('set-name').value = this.data.shop.shopName;
                document.getElementById('set-upi').value = this.data.shop.upi || '';
                document.getElementById('set-phone').value = this.data.shop.phone;
                document.getElementById('set-address').value = this.data.shop.address;
                document.getElementById('set-gstin').value = this.data.shop.gstin || '';
            },
            
            updateProfile: function() {
                this.data.shop.shopName = document.getElementById('set-name').value;
                this.data.shop.upi = document.getElementById('set-upi').value;
                this.data.shop.phone = document.getElementById('set-phone').value;
                this.data.shop.address = document.getElementById('set-address').value;
                this.data.shop.gstin = document.getElementById('set-gstin').value;
                this.save();
                alert('Profile Updated!');
            },

            exportExcel: function() {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.invoices), "Sales");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.expenses), "Expenses");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.items), "Stock");
                XLSX.writeFile(wb, `DigitMart_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
            },

            backupFlow: function() {
                const a = document.createElement('a');
                a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
                a.download = `DigitMart_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
            },
            
            restore: function(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                if(file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.onload = function(e) {
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                            if(wb.Sheets["Sales"]) app.data.invoices = XLSX.utils.sheet_to_json(wb.Sheets["Sales"]).reverse();
                            if(wb.Sheets["Expenses"]) app.data.expenses = XLSX.utils.sheet_to_json(wb.Sheets["Expenses"]);
                            if(wb.Sheets["Stock"]) app.data.items = XLSX.utils.sheet_to_json(wb.Sheets["Stock"]);
                            app.save(); alert('Excel Restored!'); location.reload();
                        } catch(err) { alert('Error reading Excel'); }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.onload = function(e) {
                        try {
                            const d = JSON.parse(e.target.result);
                            if(d.shop && d.invoices) { localStorage.setItem(DB_KEY, JSON.stringify(d)); alert('Restored!'); location.reload(); }
                        } catch(err) { alert('Corrupt JSON'); }
                    };
                    reader.readAsText(file);
                }
            },

            // --- NEW: Share DigitTools Function ---
            shareDigitTools: function() {
                const text = `Hey! Check out DigitPhone by DigitMart for secure tools: https://digitsync.github.io/DigitPhone/`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>
