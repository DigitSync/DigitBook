<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DigitMart BillBook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap'); 
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow: hidden; height: 100vh; width: 100vw; }
        .scroll-area::-webkit-scrollbar { width: 0px; background: transparent; }
        .scroll-area { -ms-overflow-style: none; scrollbar-width: none; }

        #invoice-modern-render { width: 794px; min-height: 1123px; background: white; position: fixed; top: 0; left: -9999px; z-index: -1; }

        .card-grad-1 { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); transition: transform 0.1s; cursor: pointer; }
        .card-grad-1:active { transform: scale(0.96); }
        .card-grad-2 { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); transition: transform 0.1s; cursor: pointer; }
        .card-grad-2:active { transform: scale(0.96); }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .badge-paid { background-color: #dcfce7; color: #15803d; font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 800; }
        .filter-active { background-color: #2563eb; color: white; border-color: #2563eb; }

        /* --- BIG & BRIGHT CALCULATOR STYLES --- */
        .calc-container { 
            background-color: #ffffff; 
            box-shadow: 0 -4px 30px rgba(0,0,0,0.15); 
            border-radius: 24px 24px 0 0; 
            z-index: 50;
        }
        .calc-screen { background-color: #f1f5f9; color: #0f172a; font-family: 'VT323', monospace; letter-spacing: 3px; border: 2px solid #e2e8f0; }
        
        /* XL Buttons */
        .btn-xl { 
            @apply h-16 rounded-2xl font-black text-2xl flex items-center justify-center shadow-md transition-all active:scale-95 active:shadow-inner border-b-[5px] active:border-b-0 active:translate-y-1 active:h-[60px];
        }
        .btn-num { background-color: #ffffff; color: #1e40af; border-color: #bfdbfe; } /* White with Blue Text */
        .btn-op { background-color: #2563eb; color: white; border-color: #1e40af; } /* Bright Blue */
        .btn-ac { background-color: #ef4444; color: white; border-color: #b91c1c; } /* Red */
        .btn-eq { background-color: #2563eb; color: white; border-color: #1e40af; } /* Blue */

        .gst-btn { @apply text-xs font-bold py-2 px-1 rounded-lg bg-blue-50 text-blue-700 border border-blue-100 active:bg-blue-200 active:scale-95 transition text-center; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 select-none bg-slate-50">

    <!-- LOGIN & SETUP (Hidden) -->
    <div id="view-login" class="fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6 hidden">
        <div class="w-24 h-24 bg-blue-600 rounded-3xl flex items-center justify-center text-white text-4xl font-black mb-6 shadow-2xl rotate-3">DM</div>
        <h1 class="text-3xl font-extrabold text-slate-900 mb-1">DigitMart</h1>
        <div class="w-full max-w-xs space-y-4 mt-8">
            <div id="login-shop-display" class="text-center font-bold text-lg text-blue-700 hidden"></div>
            <input type="password" id="input-pass" placeholder="Password" class="w-full p-4 border-2 border-slate-200 rounded-2xl text-center text-xl font-bold outline-none focus:border-blue-600">
            <button onclick="app.login()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-xl text-lg">UNLOCK</button>
        </div>
        <div class="absolute bottom-8 text-xs font-bold text-slate-300">Powered by DigitMart</div>
    </div>

    <div id="view-setup" class="fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6 hidden">
        <div class="w-full max-w-md p-4">
            <h2 class="text-3xl font-black mb-6 text-slate-800">Setup Shop</h2>
            <form onsubmit="app.saveSetup(event)" class="space-y-4">
                <input name="shopName" placeholder="Shop Name" required class="w-full p-4 border-2 rounded-xl font-bold outline-none focus:border-blue-500">
                <input name="address" placeholder="Address" required class="w-full p-4 border-2 rounded-xl font-bold outline-none focus:border-blue-500">
                <input name="phone" placeholder="Phone" required type="number" class="w-full p-4 border-2 rounded-xl font-bold outline-none focus:border-blue-500">
                <input name="upi" placeholder="UPI ID (Optional)" class="w-full p-4 border-2 rounded-xl font-bold outline-none focus:border-blue-500">
                <input name="gstin" placeholder="GSTIN (Optional)" class="w-full p-4 border-2 rounded-xl font-bold outline-none focus:border-blue-500">
                <input name="password" placeholder="Create Password" type="password" class="w-full p-4 border-2 rounded-xl font-bold outline-none focus:border-blue-500">
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg mt-4 text-lg">START</button>
            </form>
        </div>
    </div>

    <!-- HEADER -->
    <div class="bg-white px-5 py-3 shadow-sm border-b z-30 flex-none flex justify-between items-center h-16">
        <div class="flex items-center gap-3">
            <button id="back-btn" onclick="app.nav('dashboard')" class="hidden w-10 h-10 bg-slate-50 rounded-xl hover:bg-slate-100 flex items-center justify-center transition active:scale-95 border border-slate-200">
                <i class="fa-solid fa-arrow-left text-slate-600 text-lg"></i>
            </button>
            <div>
                <h1 id="header-shop-name" class="font-black text-2xl text-slate-800 leading-none tracking-tight">DigitMart</h1>
            </div>
        </div>
        <div onclick="app.nav('settings')" class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-600 border border-slate-200 cursor-pointer hover:text-blue-600 active:scale-95 transition">
            <i class="fa-solid fa-gear text-lg"></i>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content" class="flex-1 flex flex-col overflow-hidden relative bg-slate-50">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="h-full flex flex-col w-full fade-in">
            
            <!-- SCROLLABLE TOP -->
            <div class="flex-1 overflow-y-auto scroll-area p-4">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div onclick="app.nav('history')" class="card-grad-1 p-5 rounded-3xl shadow-lg shadow-blue-200 text-white relative overflow-hidden group">
                        <span class="text-xs font-bold opacity-80 uppercase tracking-wider">Total Sales</span>
                        <h2 class="text-3xl font-black mt-1">₹ <span id="dash-total">0</span></h2>
                        <i class="fa-solid fa-chevron-right absolute right-5 top-1/2 transform -translate-y-1/2 opacity-40 text-2xl"></i>
                    </div>
                    <div onclick="app.nav('expenses')" class="card-grad-2 p-5 rounded-3xl shadow-lg shadow-red-200 text-white relative overflow-hidden group">
                        <span class="text-xs font-bold opacity-80 uppercase tracking-wider">Expenses</span>
                        <h2 class="text-3xl font-black mt-1">₹ <span id="dash-expense">0</span></h2>
                        <i class="fa-solid fa-chevron-right absolute right-5 top-1/2 transform -translate-y-1/2 opacity-40 text-2xl"></i>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 mb-4">
                    <button onclick="app.nav('history')" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-1 active:scale-95 transition h-24">
                        <i class="fa-solid fa-file-invoice text-blue-600 text-2xl"></i><span class="text-xs font-bold text-slate-600">List</span>
                    </button>
                    <button onclick="app.nav('credit')" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-1 active:scale-95 transition h-24">
                        <i class="fa-solid fa-book-open text-orange-500 text-2xl"></i><span class="text-xs font-bold text-slate-600">Credit</span>
                    </button>
                    <button onclick="app.nav('items')" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-1 active:scale-95 transition h-24">
                        <i class="fa-solid fa-box-open text-purple-600 text-2xl"></i><span class="text-xs font-bold text-slate-600">Stock</span>
                    </button>
                </div>
            </div>

            <!-- BIG FIXED CALCULATOR -->
            <div class="flex-none calc-container w-full border-t border-slate-200 relative z-20">
                <!-- Display -->
                <div class="px-5 pt-5 pb-2">
                    <div class="calc-screen p-3 text-right text-6xl font-bold rounded-2xl h-20 flex items-center justify-end overflow-hidden text-slate-800 shadow-inner" id="calc-display">0</div>
                </div>

                <!-- GST Buttons -->
                <div class="grid grid-cols-5 gap-2 px-5 mb-3">
                    <button onclick="calc.addGST(3)" class="gst-btn">+3%</button>
                    <button onclick="calc.addGST(5)" class="gst-btn">+5%</button>
                    <button onclick="calc.addGST(18)" class="gst-btn">+18%</button>
                    <button onclick="calc.addGST(28)" class="gst-btn">+28%</button>
                    <button onclick="calc.addCustomGST(1)" class="gst-btn border-green-200 bg-green-50 text-green-700">+GST</button>

                    <button onclick="calc.addGST(-3)" class="gst-btn text-red-500 border-red-100 bg-red-50">-3%</button>
                    <button onclick="calc.addGST(-5)" class="gst-btn text-red-500 border-red-100 bg-red-50">-5%</button>
                    <button onclick="calc.addGST(-18)" class="gst-btn text-red-500 border-red-100 bg-red-50">-18%</button>
                    <button onclick="calc.addGST(-28)" class="gst-btn text-red-500 border-red-100 bg-red-50">-28%</button>
                    <button onclick="calc.addCustomGST(-1)" class="gst-btn border-red-200 bg-red-50 text-red-700">-GST</button>
                </div>

                <!-- Big Keypad -->
                <div class="grid grid-cols-4 gap-3 px-5 pb-24">
                    <button onclick="calc.num(7)" class="btn-xl btn-num">7</button>
                    <button onclick="calc.num(8)" class="btn-xl btn-num">8</button>
                    <button onclick="calc.num(9)" class="btn-xl btn-num">9</button>
                    <button onclick="calc.clear()" class="btn-xl btn-ac">AC</button>

                    <button onclick="calc.num(4)" class="btn-xl btn-num">4</button>
                    <button onclick="calc.num(5)" class="btn-xl btn-num">5</button>
                    <button onclick="calc.num(6)" class="btn-xl btn-num">6</button>
                    <button onclick="calc.op('/')" class="btn-xl btn-op">÷</button>

                    <button onclick="calc.num(1)" class="btn-xl btn-num">1</button>
                    <button onclick="calc.num(2)" class="btn-xl btn-num">2</button>
                    <button onclick="calc.num(3)" class="btn-xl btn-num">3</button>
                    <button onclick="calc.op('*')" class="btn-xl btn-op">×</button>

                    <button onclick="calc.num(0)" class="btn-xl btn-num">0</button>
                    <button onclick="calc.num('00')" class="btn-xl btn-num">00</button>
                    <button onclick="calc.num('.')" class="btn-xl btn-num">.</button>
                    <button onclick="calc.op('-')" class="btn-xl btn-op">−</button>
                    
                    <button onclick="calc.del()" class="btn-xl btn-op text-2xl"><i class="fa-solid fa-delete-left"></i></button>
                    <button onclick="calc.op('%')" class="btn-xl btn-op">%</button>
                    <button onclick="calc.op('+')" class="btn-xl btn-op">+</button>
                    <button onclick="calc.solve()" class="btn-xl btn-eq">=</button>
                </div>

                <!-- CIRCULAR ACTION BAR -->
                <div class="absolute bottom-0 left-0 w-full h-20 bg-white border-t border-slate-100 flex justify-between items-center px-10 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] rounded-t-3xl">
                    <button onclick="app.quickSaleCalc()" class="flex flex-col items-center justify-center text-green-600 active:scale-90 transition group w-16">
                        <div class="w-12 h-1 bg-green-500 rounded-full mb-1 group-active:w-8 transition-all"></div>
                        <span class="text-xs font-black tracking-wide">CASH IN</span>
                    </button>

                    <button onclick="app.newBill()" class="w-16 h-16 bg-blue-600 rounded-full text-white text-3xl shadow-2xl shadow-blue-400 flex items-center justify-center border-4 border-white -mt-10 active:scale-90 transition hover:scale-110 hover:bg-blue-700">
                        <i class="fa-solid fa-plus"></i>
                    </button>

                    <button onclick="app.quickExpenseCalc()" class="flex flex-col items-center justify-center text-red-500 active:scale-90 transition group w-16">
                        <div class="w-12 h-1 bg-red-500 rounded-full mb-1 group-active:w-8 transition-all"></div>
                        <span class="text-xs font-black tracking-wide">CASH OUT</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- OTHER VIEWS (Overlays) -->
        <div id="view-billing" class="hidden h-full flex flex-col fade-in bg-slate-100">
            <div class="bg-white p-6 m-4 rounded-3xl shadow-sm border border-slate-200 flex-1 overflow-y-auto scroll-area">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Invoice #</span>
                    <span class="font-mono font-bold text-slate-800 bg-slate-100 px-3 py-1 rounded-lg" id="bill-inv-no">INV-000</span>
                </div>
                <div class="space-y-5">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <input id="bill-cust-name" placeholder="Customer Name" class="w-full bg-transparent outline-none text-base font-bold mb-3 placeholder-slate-400">
                        <div class="h-px bg-slate-200 mb-3"></div>
                        <input id="bill-cust-phone" type="number" placeholder="Phone Number" class="w-full bg-transparent outline-none text-base font-bold placeholder-slate-400">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Item Details</label>
                        <input id="bill-item-name" list="item-suggestions" oninput="app.checkItemPrice()" placeholder="Search Item..." class="w-full p-4 mt-1 bg-white border-2 border-slate-200 rounded-2xl outline-none font-bold text-slate-700 focus:border-blue-500 transition shadow-sm">
                        <datalist id="item-suggestions"></datalist>
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Price (₹)</label>
                            <input id="bill-amount" type="number" placeholder="0" class="w-full p-4 mt-1 bg-white border-2 border-slate-200 rounded-2xl outline-none text-xl font-black text-slate-800 focus:border-blue-500 transition shadow-sm" onkeyup="app.calculateTotal()">
                        </div>
                        <div class="w-28">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">GST %</label>
                            <select id="bill-gst" class="w-full p-4 mt-1 bg-white border-2 border-slate-200 rounded-2xl outline-none font-bold text-slate-600 shadow-sm" onchange="app.calculateTotal()">
                                <option value="0">0%</option><option value="5">5%</option><option value="12">12%</option><option value="18">18%</option><option value="28">28%</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-between items-center px-2">
                         <span class="text-xs font-bold text-slate-400">Total Payable</span>
                         <span class="text-3xl font-black text-blue-600">₹ <span id="bill-final-total">0.00</span></span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 bg-slate-100 p-1.5 rounded-2xl">
                        <button onclick="app.setMode('Cash')" id="mode-Cash" class="mode-btn py-3 rounded-xl text-xs font-black bg-white text-blue-600 shadow-sm transition">Cash</button>
                        <button onclick="app.setMode('UPI')" id="mode-UPI" class="mode-btn py-3 rounded-xl text-xs font-black text-slate-400 hover:bg-white/50 transition">UPI</button>
                        <button onclick="app.setMode('Credit')" id="mode-Credit" class="mode-btn py-3 rounded-xl text-xs font-black text-slate-400 hover:bg-white/50 transition">Credit</button>
                    </div>
                    <div id="live-qr-container" class="hidden flex flex-col items-center justify-center p-6 bg-white border-2 border-dashed border-blue-200 rounded-3xl">
                        <div id="live-qrcode" class="bg-white p-1 rounded-xl"></div>
                        <p class="text-xs font-bold text-blue-500 mt-3 uppercase tracking-wide">Scan to Pay</p>
                    </div>
                </div>
            </div>
            <div class="mt-2 mx-4 mb-4 grid grid-cols-2 gap-4 flex-none pb-4">
                <button onclick="app.saveBill(true)" class="bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition text-lg">Save & New</button>
                <button onclick="app.saveBill(false)" class="bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition text-lg">Save Bill</button>
            </div>
        </div>

        <!-- CREDIT BOOK -->
        <div id="view-credit" class="hidden h-full flex flex-col fade-in p-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-orange-100 mb-4 flex-none">
                <h3 class="text-sm font-black text-orange-600 mb-4 flex items-center gap-2"><i class="fa-solid fa-plus-circle"></i> New Entry</h3>
                <div class="space-y-4">
                    <input id="cred-name" placeholder="Name" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-orange-200 rounded-2xl outline-none text-sm font-bold transition">
                    <div class="flex gap-3">
                        <input id="cred-phone" type="number" placeholder="Phone" class="flex-1 p-4 bg-slate-50 border-2 border-transparent focus:border-orange-200 rounded-2xl outline-none text-sm font-bold transition">
                        <input id="cred-amt" type="number" placeholder="₹ Amount" class="w-32 p-4 bg-orange-50 border-2 border-transparent focus:border-orange-200 rounded-2xl outline-none text-sm font-black text-orange-600 transition">
                    </div>
                    <input id="cred-note" placeholder="Note (e.g. EMI)" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-orange-200 rounded-2xl outline-none text-sm font-bold transition">
                    <button onclick="app.addCredit()" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold text-sm shadow-lg active:scale-95">Add to Udhaar</button>
                </div>
            </div>
            <div id="credit-list" class="space-y-3 flex-1 overflow-y-auto scroll-area pb-4"></div>
        </div>

        <!-- HISTORY -->
        <div id="view-history" class="hidden h-full flex flex-col fade-in p-4">
            <div class="flex gap-3 mb-4 flex-none">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Total Sale</span>
                    <h2 class="text-xl font-black text-slate-800 mt-1">₹ <span id="hist-total">0.00</span></h2>
                </div>
                <button onclick="app.exportExcel()" class="bg-green-50 px-6 rounded-2xl text-green-700 font-bold text-xs border border-green-100 active:scale-95 flex flex-col items-center justify-center">
                    <i class="fa-solid fa-file-excel text-2xl mb-1"></i> Export
                </button>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-4 flex-none">
                <div class="h-32 w-full"><canvas id="salesChart"></canvas></div>
            </div>
            <div class="flex bg-white p-1 rounded-xl mb-4 shadow-sm border border-slate-200 flex-none">
                <button onclick="app.filterHistory('today')" id="btn-today" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all filter-active">Today</button>
                <button onclick="app.filterHistory('month')" id="btn-month" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-400">Month</button>
                <button onclick="app.filterHistory('all')" id="btn-all" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-400">All</button>
            </div>
            <div id="history-list" class="space-y-3 flex-1 overflow-y-auto scroll-area pb-4"></div>
        </div>

        <!-- EXPENSES & STOCK (Simplified) -->
        <div id="view-expenses" class="hidden h-full flex flex-col fade-in p-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 mb-4 flex-none">
                <h3 class="font-bold text-slate-700 mb-4 text-lg">Add Expense</h3>
                <div class="flex gap-3 mb-4">
                    <input id="exp-name" placeholder="Details" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                    <input id="exp-amt" type="number" placeholder="₹" class="w-28 p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                </div>
                <button onclick="app.addExpense()" class="w-full bg-red-500 text-white py-4 rounded-2xl font-bold text-sm shadow-md">Add Expense</button>
            </div>
            <div id="expense-list" class="space-y-2 flex-1 overflow-y-auto scroll-area pb-4"></div>
        </div>

        <div id="view-items" class="hidden h-full flex flex-col fade-in p-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 mb-4 flex-none">
                <h3 class="font-bold text-slate-700 mb-4 text-lg">Add Stock</h3>
                <div class="flex gap-3 mb-4">
                    <input id="stock-name" placeholder="Item Name" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                    <input id="stock-price" type="number" placeholder="₹ Price" class="w-28 p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                </div>
                <button onclick="app.addStockItem()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-sm shadow-md">Add Item</button>
            </div>
            <div id="stock-list" class="space-y-2 flex-1 overflow-y-auto scroll-area pb-4"></div>
        </div>

        <!-- SETTINGS -->
        <div id="view-settings" class="hidden h-full flex flex-col fade-in p-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 space-y-4 flex-1 overflow-y-auto scroll-area">
                <h2 class="font-black text-xl border-b pb-3">Settings</h2>
                <input id="set-name" placeholder="Shop Name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                <input id="set-phone" placeholder="Phone" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                <input id="set-address" placeholder="Address" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                <input id="set-upi" placeholder="UPI ID" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                <input id="set-gstin" placeholder="GSTIN" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                <input id="set-pass" placeholder="App Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm font-bold">
                
                <button onclick="app.updateProfile()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg">Update Profile</button>
                
                <div class="h-px bg-slate-100 my-2"></div>
                <button onclick="app.showTrash()" class="w-full bg-red-50 text-red-500 py-4 rounded-2xl font-bold border border-red-100 text-sm flex justify-center items-center gap-2"><i class="fa-solid fa-trash"></i> Trash Bin</button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.exportExcel()" class="bg-green-50 text-green-700 py-4 rounded-2xl font-bold border border-green-100 text-xs flex flex-col items-center justify-center gap-1"><i class="fa-solid fa-file-excel text-lg"></i> Excel Backup</button>
                    <button onclick="app.backupFlow()" class="bg-blue-50 text-blue-700 py-4 rounded-2xl font-bold border border-blue-100 text-xs flex flex-col items-center justify-center gap-1"><i class="fa-solid fa-download text-lg"></i> JSON Backup</button>
                </div>
                <label class="block bg-slate-50 text-slate-500 py-4 rounded-2xl font-bold border-2 border-dashed border-slate-200 text-xs text-center cursor-pointer hover:bg-slate-100 transition"><i class="fa-solid fa-upload mr-1"></i> Restore Data (Excel/JSON)<input type="file" class="hidden" onchange="app.restore(this)"></label>
                <button onclick="app.shareDigitTools()" class="w-full bg-indigo-50 text-indigo-600 py-4 rounded-2xl font-bold border border-indigo-100 text-xs flex items-center justify-center gap-2"><i class="fa-solid fa-share-nodes"></i> Share DigitTools</button>
                <button onclick="app.logout()" class="w-full text-red-500 py-2 font-bold text-xs mt-2">Logout</button>
            </div>
        </div>

        <!-- TRASH BIN -->
        <div id="view-trash" class="fixed inset-0 bg-white z-40 hidden flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50">
                <h2 class="font-bold text-xl">Trash Bin <span class="text-xs font-normal text-slate-500 ml-1">(7 Days)</span></h2>
                <button onclick="document.getElementById('view-trash').classList.add('hidden')" class="w-10 h-10 bg-slate-200 rounded-full font-bold text-lg">✕</button>
            </div>
            <div id="trash-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50"></div>
        </div>
    </div>

    <!-- MODALS & HIDDEN -->
    <div id="success-modal" class="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-4 hidden backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center shadow-2xl">
             <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner"><i class="fa-solid fa-check"></i></div>
             <h2 class="text-2xl font-black text-slate-800">Saved Successfully!</h2>
             <p class="text-sm text-slate-500 mb-6 font-bold">Invoice Generated</p>
             <div class="grid grid-cols-2 gap-4">
                 <button onclick="app.downloadBillAction()" class="bg-slate-800 text-white py-3 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95"><i class="fa-solid fa-download"></i> Download</button>
                 <button onclick="app.shareBillAction()" class="bg-green-500 text-white py-3 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95"><i class="fa-brands fa-whatsapp text-lg"></i> Share</button>
             </div>
             <button onclick="document.getElementById('success-modal').classList.add('hidden')" class="text-slate-400 text-xs font-bold mt-6 hover:text-slate-600">Close Window</button>
        </div>
    </div>

    <div id="invoice-modern-render" class="p-8 text-slate-800 font-sans bg-white">
        <div class="bg-[#003366] text-white p-8 flex justify-between items-center">
            <div><h1 class="text-4xl font-bold uppercase tracking-wider" id="mod-shop-name">SHOP</h1><p class="text-sm mt-1 opacity-80 tracking-widest">INVOICE</p></div>
            <div class="text-right"><h2 class="text-3xl font-bold" id="mod-inv-total">₹0</h2></div>
        </div>
        <div class="p-10">
            <div class="flex justify-between mb-10">
                <div class="w-1/2"><p class="text-xs font-bold text-slate-400 uppercase mb-1">From</p><p class="font-bold text-lg text-slate-800" id="mod-from-name"></p><p class="text-sm text-slate-600 w-2/3" id="mod-from-addr"></p><p class="text-sm text-slate-600 mt-1">Ph: <span id="mod-from-phone"></span></p><p class="text-sm text-slate-600">GSTIN: <span id="mod-from-gst"></span></p></div>
                <div class="w-1/2 text-right"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Bill To</p><p class="font-bold text-lg text-slate-800" id="mod-to-name">Guest</p><p class="text-sm text-slate-600" id="mod-to-phone">Phone</p><div class="mt-4 inline-block text-right bg-slate-50 p-3 rounded-lg border border-slate-100"><p class="text-sm"><span class="font-bold text-slate-500">Invoice #:</span> <span class="font-bold" id="mod-inv-no"></span></p><p class="text-sm"><span class="font-bold text-slate-500">Date:</span> <span class="font-bold" id="mod-inv-date"></span></p></div></div>
            </div>
            <table class="w-full mb-8 border-collapse"><thead class="bg-[#003366] text-white"><tr><th class="p-4 text-left text-sm font-bold uppercase w-1/2">Description</th><th class="p-4 text-center text-sm font-bold uppercase">Qty</th><th class="p-4 text-center text-sm font-bold uppercase">Price</th><th class="p-4 text-center text-sm font-bold uppercase">GST</th><th class="p-4 text-right text-sm font-bold uppercase">Amount</th></tr></thead><tbody id="mod-tbody" class="text-sm text-slate-700"></tbody></table>
            <div class="flex justify-end"><div class="w-72"><div class="flex justify-between py-2 border-b border-slate-200"><span class="text-slate-500 font-medium">Subtotal</span><span class="font-bold" id="mod-subtotal">0.00</span></div><div class="flex justify-between py-2 border-b border-slate-200"><span class="text-slate-500 font-medium">Tax (GST)</span><span class="font-bold" id="mod-tax">0.00</span></div><div class="flex justify-between py-3 font-bold text-xl text-[#003366]"><span>TOTAL</span><span>₹ <span id="mod-grand-total">0.00</span></span></div></div></div>
            <div class="mt-20 pt-8 border-t-2 border-slate-100 text-center"><p class="text-sm font-bold text-slate-700">Thank you for your business!</p><p class="text-xs text-slate-500 mt-1">Payment Info: UPI - <span id="mod-upi" class="font-mono text-slate-800"></span></p><div class="mt-6 text-[10px] text-slate-300 font-bold uppercase tracking-widest">Powered by DigitMart</div></div>
        </div>
    </div>

    <script>
        const DB_KEY = 'digitmart_billbook_v23';
        const OLD_KEYS = ['digitmart_billbook_v22', 'digitmart_billbook_v21', 'digitmart_billbook_v20'];
        let salesChartInstance = null;

        const calc = {
            display: '0',
            addGST: function(percent) {
                let val = parseFloat(this.display); if(isNaN(val)) return;
                let tax = val * (Math.abs(percent) / 100);
                this.display = String(percent > 0 ? (val + tax) : (val - tax));
                this.update();
            },
            addCustomGST: function(sign) { let rate = prompt("Enter GST %:"); if(rate) this.addGST(sign * parseFloat(rate)); },
            num: function(n) { if(this.display === '0') this.display = String(n); else this.display += String(n); this.update(); },
            op: function(o) { this.display += o; this.update(); },
            clear: function() { this.display = '0'; this.update(); },
            del: function() { this.display = this.display.slice(0, -1) || '0'; this.update(); },
            solve: function() { try { this.display = String(eval(this.display)); } catch { this.display = 'Error'; } this.update(); },
            update: function() { document.getElementById('calc-display').innerText = this.display; },
            getVal: function() { return parseFloat(this.display) || 0; }
        };

        const app = {
            data: { shop: null, invoices: [], expenses: [], items: [], credits: [], trash: [] },
            currentMode: 'Cash', currentInv: null,

            init: function() {
                let stored = localStorage.getItem(DB_KEY);
                if(!stored) { for(let key of OLD_KEYS) { const old = localStorage.getItem(key); if(old) { stored = old; break; } } }
                if(stored) {
                    this.data = JSON.parse(stored);
                    if(!this.data.credits) this.data.credits = [];
                    if(!this.data.trash) this.data.trash = [];
                    if(this.data.items.length > 0 && typeof this.data.items[0] === 'string') this.data.items = this.data.items.map(name => ({name, price: ''}));
                    this.cleanupTrash();
                }
                
                if(this.data.shop) {
                    if(this.data.shop.password && this.data.shop.password.trim() !== "") {
                        document.getElementById('view-login').classList.remove('hidden');
                        document.getElementById('login-shop-display').innerText = this.data.shop.shopName;
                        document.getElementById('login-shop-display').classList.remove('hidden');
                    } else {
                        document.getElementById('app-interface').classList.remove('hidden');
                        this.loadSettings();
                        this.nav('dashboard');
                    }
                } else { document.getElementById('view-setup').classList.remove('hidden'); }
            },

            save: function() { localStorage.setItem(DB_KEY, JSON.stringify(this.data)); this.updateDashboard(); },
            moveToTrash: function(item, type) { this.data.trash.push({ ...item, deletedAt: Date.now(), type: type }); },
            cleanupTrash: function() { const week = 7*24*60*60*1000; this.data.trash = this.data.trash.filter(i => (Date.now() - i.deletedAt) < week); this.save(); },
            
            showTrash: function() {
                const list = document.getElementById('trash-list');
                list.innerHTML = '';
                if(this.data.trash.length === 0) list.innerHTML = '<div class="text-center text-slate-400 mt-10 font-bold">Bin is Empty</div>';
                else {
                    this.data.trash.forEach((item, idx) => {
                        list.innerHTML += `<div class="bg-white p-4 rounded-2xl border border-slate-200 flex justify-between items-center mb-2"><div><span class="text-[10px] font-black bg-slate-100 px-2 py-1 rounded text-slate-500 uppercase">${item.type}</span><div class="font-bold text-base text-slate-800 mt-1">${item.name || item.no}</div></div><button onclick="app.restoreFromTrash(${idx})" class="text-blue-600 font-bold text-xs bg-blue-50 px-4 py-2 rounded-xl">Restore</button></div>`;
                    });
                }
                document.getElementById('view-trash').classList.remove('hidden');
            },
            restoreFromTrash: function(idx) {
                const item = this.data.trash[idx];
                this.data.trash.splice(idx, 1);
                if(item.type === 'invoice') this.data.invoices.unshift(item);
                else if(item.type === 'credit') this.data.credits.unshift(item);
                else if(item.type === 'expense') this.data.expenses.unshift(item);
                this.save(); this.showTrash(); alert('Restored!');
            },
            deleteExpense: function(id) { const item = this.data.expenses.find(e => e.id === id); if(confirm('Move Expense to Trash?')) { this.moveToTrash(item, 'expense'); this.data.expenses = this.data.expenses.filter(e => e.id !== id); this.save(); this.renderExpenses(); this.updateDashboard(); } },

            nav: function(viewId) {
                document.querySelectorAll('#main-content > div').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + viewId).classList.remove('hidden');
                document.getElementById('header-shop-name').innerText = this.data.shop.shopName;
                const fab = document.getElementById('fab-btn');
                const backBtn = document.getElementById('back-btn');
                if(viewId === 'dashboard') { backBtn.classList.add('hidden'); } else { backBtn.classList.remove('hidden'); }
                if(viewId === 'billing') { document.getElementById('bill-inv-no').innerText = `INV-${String(this.data.invoices.length + 1).padStart(4, '0')}`; this.populateItemSuggestions(); }
                if(viewId === 'history') { this.filterHistory('today'); this.renderSalesChart(); }
                if(viewId === 'expenses') this.renderExpenses();
                if(viewId === 'items') this.renderStockItems();
                if(viewId === 'credit') this.renderCredits();
                this.updateDashboard();
            },

            // SMART QUICK ADD LOGIC
            quickSaleCalc: function() {
                const val = calc.getVal();
                if(val <= 0) return alert("Amount must be > 0");
                if(confirm(`Add ₹${val} to Sales?`)) {
                    const inv = { id: Date.now(), no: `INV-${String(this.data.invoices.length+1).padStart(4,'0')}`, date: new Date().toLocaleDateString('en-IN'), rawDate: new Date(), time: new Date().toLocaleTimeString(), item: 'Quick Sale', rate: val, gstPercent: 0, taxAmount: 0, grandTotal: val.toFixed(2), mode: 'Cash', phone: '', name: 'Walk-in' };
                    this.data.invoices.unshift(inv);
                    this.save();
                    alert("Sale Added!");
                    calc.clear();
                }
            },
            quickExpenseCalc: function() {
                const val = calc.getVal();
                if(val <= 0) return alert("Amount must be > 0");
                if(confirm(`Add ₹${val} to Expenses?`)) {
                    this.data.expenses.unshift({ id: Date.now(), name: "Quick Expense", amount: val, date: new Date().toLocaleDateString('en-IN') });
                    this.save();
                    alert("Expense Added!");
                    calc.clear();
                }
            },

            saveSetup: function(e) { e.preventDefault(); const fd = new FormData(e.target); this.data.shop = Object.fromEntries(fd.entries()); this.save(); location.reload(); },
            login: function() { if(document.getElementById('input-pass').value === this.data.shop.password) { document.getElementById('view-login').classList.add('hidden'); document.getElementById('app-interface').classList.remove('hidden'); this.loadSettings(); this.nav('dashboard'); } else alert('Wrong Password'); },
            logout: function() { location.reload(); },
            updateDashboard: function() {
                const totalSale = this.data.invoices.reduce((sum, i) => sum + parseFloat(i.grandTotal), 0);
                const totalExp = this.data.expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
                document.getElementById('dash-total').innerText = totalSale.toLocaleString('en-IN');
                document.getElementById('dash-expense').innerText = totalExp.toLocaleString('en-IN');
            },
            newBill: function(presetAmt) { 
                this.currentMode = 'Cash'; this.updateModeUI(); 
                document.getElementById('bill-cust-name').value=''; 
                document.getElementById('bill-item-name').value=''; 
                document.getElementById('bill-amount').value=''; 
                document.getElementById('bill-cust-phone').value=''; 
                document.getElementById('bill-gst').value='0'; 
                document.getElementById('bill-final-total').innerText='0.00'; 
                document.getElementById('live-qr-container').classList.add('hidden'); 
                this.nav('billing');
                if(presetAmt) { document.getElementById('bill-amount').value = presetAmt; this.calculateTotal(); }
            },
            setMode: function(mode) { this.currentMode = mode; this.updateModeUI(); this.calculateTotal(); },
            updateModeUI: function() { document.querySelectorAll('.mode-btn').forEach(b => b.className = "mode-btn py-3 rounded-xl text-xs font-black text-slate-400 hover:bg-white/50 transition"); document.getElementById('mode-' + this.currentMode).className = "mode-btn py-3 rounded-xl text-xs font-black bg-white text-blue-600 shadow-sm transition ring-1 ring-blue-100"; },
            checkItemPrice: function() { const val = document.getElementById('bill-item-name').value; const item = this.data.items.find(i => i.name === val); if(item && item.price) { document.getElementById('bill-amount').value = item.price; this.calculateTotal(); } },
            calculateTotal: function() { const price = parseFloat(document.getElementById('bill-amount').value)||0; const gstRate = parseFloat(document.getElementById('bill-gst').value)||0; const taxAmt = (price*gstRate)/100; const total = price+taxAmt; document.getElementById('bill-final-total').innerText = total.toFixed(2); const qrCont = document.getElementById('live-qr-container'); const qrDiv = document.getElementById('live-qrcode'); if(this.currentMode === 'UPI' && total>0 && this.data.shop.upi) { qrCont.classList.remove('hidden'); qrDiv.innerHTML = ''; new QRCode(qrDiv, { text: `upi://pay?pa=${this.data.shop.upi}&pn=${encodeURIComponent(this.data.shop.shopName)}&am=${total.toFixed(2)}&cu=INR`, width: 120, height: 120 }); } else { qrCont.classList.add('hidden'); } return { price, gstRate, taxAmt, total }; },
            
            saveBill: function(isNew) {
                const calcs = this.calculateTotal();
                if(!calcs.price || calcs.price <= 0) return alert('Amount required!');
                const inv = { id: Date.now(), no: `INV-${String(this.data.invoices.length+1).padStart(4,'0')}`, date: new Date().toLocaleDateString('en-IN'), rawDate: new Date(), time: new Date().toLocaleTimeString(), item: document.getElementById('bill-item-name').value || 'Sale', rate: calcs.price, gstPercent: calcs.gstRate, taxAmount: calcs.taxAmt, grandTotal: calcs.total.toFixed(2), mode: this.currentMode, phone: document.getElementById('bill-cust-phone').value, name: document.getElementById('bill-cust-name').value || 'Guest' };
                this.data.invoices.unshift(inv);
                if(this.currentMode === 'Credit') this.data.credits.unshift({ id: Date.now()+1, name: inv.name, phone: inv.phone, amount: parseFloat(inv.grandTotal), note: `Inv ${inv.no}`, date: inv.date });
                this.save(); this.currentInv = inv;
                if(isNew) { const btn = event.target; const txt = btn.innerText; btn.innerText = "Saved!"; setTimeout(() => { btn.innerText = txt; this.newBill(); }, 800); } else { document.getElementById('success-modal').classList.remove('hidden'); }
            },

            addCredit: function() { const name = document.getElementById('cred-name').value; const phone = document.getElementById('cred-phone').value; const amt = parseFloat(document.getElementById('cred-amt').value); if(!name || !amt) return alert('Name & Amount needed!'); this.data.credits.unshift({ id: Date.now(), name, phone, amount: amt, note: document.getElementById('cred-note').value || 'Manual', date: new Date().toLocaleDateString('en-IN') }); this.save(); document.getElementById('cred-name').value=''; document.getElementById('cred-phone').value=''; document.getElementById('cred-amt').value=''; document.getElementById('cred-note').value=''; this.renderCredits(); alert('Added!'); },
            renderCredits: function() { const list = document.getElementById('credit-list'); list.innerHTML = ''; if(this.data.credits.length===0) { list.innerHTML='<div class="text-center text-slate-400 mt-6 text-xs font-bold">No Dues Pending</div>'; return; } this.data.credits.forEach(c => { list.innerHTML += `<div class="bg-white p-5 rounded-3xl border border-orange-100 shadow-sm flex justify-between items-center mb-3"><div class="flex-1"><div class="font-black text-slate-800 text-base">${c.name}</div><div class="text-[10px] text-slate-500 font-bold uppercase tracking-wide mt-1">${c.date} • ${c.note}</div><div class="flex gap-2 mt-3">${c.phone ? `<button onclick="window.open('tel:${c.phone}')" class="text-[10px] bg-slate-100 px-3 py-1.5 rounded-lg text-slate-600 font-bold"><i class="fa-solid fa-phone mr-1"></i> Call</button>` : ''}${c.phone ? `<button onclick="app.sendCreditWhatsapp(${c.phone}, '${c.name}', ${c.amount})" class="text-[10px] bg-green-50 px-3 py-1.5 rounded-lg text-green-600 font-bold"><i class="fa-brands fa-whatsapp mr-1"></i> Alert</button>` : ''}</div></div><div class="text-right"><div class="font-black text-orange-600 text-xl">₹${c.amount}</div><button onclick="app.markCreditPaid(${c.id})" class="text-[10px] bg-orange-500 text-white px-4 py-2 rounded-xl mt-2 font-bold shadow-md active:scale-95">MARK PAID</button><button onclick="app.deleteCredit(${c.id})" class="text-[10px] text-red-400 block mt-2 ml-auto font-bold">Delete</button></div></div>`; }); },
            deleteCredit: function(id) { const item = this.data.credits.find(c => c.id === id); if(confirm('Move to Trash?')) { this.moveToTrash(item, 'credit'); this.data.credits = this.data.credits.filter(c => c.id !== id); this.save(); this.renderCredits(); } },
            markCreditPaid: function(id) { const idx = this.data.credits.findIndex(c => c.id === id); if(idx === -1) return; const credit = this.data.credits[idx]; if(confirm(`Mark ₹${credit.amount} as Paid? Moving to Sales.`)) { const newInv = { id: Date.now(), no: `INV-PAY-${String(this.data.invoices.length+1).padStart(3,'0')}`, date: new Date().toLocaleDateString('en-IN'), rawDate: new Date(), time: new Date().toLocaleTimeString(), item: `Payment: ${credit.note || 'Due'}`, rate: credit.amount, gstPercent: 0, taxAmount: 0, grandTotal: credit.amount.toFixed(2), mode: 'Cash', phone: credit.phone, name: credit.name }; this.data.invoices.unshift(newInv); this.data.credits.splice(idx, 1); this.save(); this.renderCredits(); alert('Payment Received! Added to Sales.'); } },
            sendCreditWhatsapp: function(phone, name, amt) { if(!phone) return alert('No Phone!'); let msg = `Hello ${name}, payment of ₹${amt} is pending at *${this.data.shop.shopName}*.`; if(this.data.shop.upi) msg += `\nPay via UPI: ${this.data.shop.upi}`; window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`, '_blank'); },
            
            prepareInvoices: function(inv) { document.getElementById('mod-shop-name').innerText = this.data.shop.shopName; document.getElementById('mod-inv-total').innerText = `₹ ${inv.grandTotal}`; document.getElementById('mod-from-name').innerText = this.data.shop.shopName; document.getElementById('mod-from-addr').innerText = this.data.shop.address; document.getElementById('mod-from-phone').innerText = this.data.shop.phone; document.getElementById('mod-from-gst').innerText = this.data.shop.gstin || 'N/A'; document.getElementById('mod-to-name').innerText = inv.name; document.getElementById('mod-to-phone').innerText = inv.phone || '-'; document.getElementById('mod-inv-no').innerText = inv.no; document.getElementById('mod-inv-date').innerText = inv.date; document.getElementById('mod-tbody').innerHTML = `<tr class="border-b border-slate-200"><td class="p-4 font-bold">${inv.item}</td><td class="p-4 text-center">1</td><td class="p-4 text-center">${inv.rate}</td><td class="p-4 text-center">${inv.gstPercent}%</td><td class="p-4 text-right font-black">${inv.grandTotal}</td></tr>`; document.getElementById('mod-subtotal').innerText = inv.rate; document.getElementById('mod-tax').innerText = parseFloat(inv.taxAmount).toFixed(2); document.getElementById('mod-grand-total').innerText = inv.grandTotal; document.getElementById('mod-upi').innerText = this.data.shop.upi || 'N/A'; },
            downloadModernJPG: function(cb) { const element = document.getElementById('invoice-modern-render'); html2canvas(element, { scale: 2 }).then(canvas => { const a = document.createElement('a'); a.download = `Invoice_${this.currentInv.no}.jpg`; a.href = canvas.toDataURL('image/jpeg', 0.9); a.click(); if(cb) cb(); }); },
            downloadBillAction: function() { if(!this.currentInv) return; this.prepareInvoices(this.currentInv); this.downloadModernJPG(); },
            shareBillAction: function() { if(!this.currentInv) return; if(!this.currentInv.phone) return alert('No Phone!'); this.prepareInvoices(this.currentInv); this.downloadModernJPG(() => { const t = `*INVOICE FROM ${this.data.shop.shopName}*\nBill: ${this.currentInv.no}\nAmt: ₹${this.currentInv.grandTotal}`; window.open(`https://wa.me/91${this.currentInv.phone}?text=${encodeURIComponent(t)}`, '_blank'); }); },
            
            addExpense: function() { const name = document.getElementById('exp-name').value; const amt = parseFloat(document.getElementById('exp-amt').value); if(!name || !amt) return; this.data.expenses.unshift({ id: Date.now(), name, amount: amt, date: new Date().toLocaleDateString('en-IN') }); this.save(); document.getElementById('exp-name').value=''; document.getElementById('exp-amt').value=''; this.renderExpenses(); },
            renderExpenses: function() { const list = document.getElementById('expense-list'); list.innerHTML = ''; this.data.expenses.forEach(e => { list.innerHTML += `<div class="bg-white p-4 rounded-3xl border border-slate-100 flex justify-between items-center mb-3"><div><span class="text-sm font-bold text-slate-800 block">${e.name}</span><span class="text-xs text-slate-400 font-bold uppercase tracking-wide">${e.date}</span></div><div class="flex items-center gap-3"><span class="font-black text-red-500 text-lg">₹${e.amount}</span><button onclick="app.deleteExpense(${e.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fa-solid fa-trash text-lg"></i></button></div></div>`; }); },
            addStockItem: function() { const name = document.getElementById('stock-name').value; const price = document.getElementById('stock-price').value; if(!name) return; this.data.items.push({name, price}); this.save(); document.getElementById('stock-name').value=''; document.getElementById('stock-price').value=''; this.renderStockItems(); },
            renderStockItems: function() { const list = document.getElementById('stock-list'); list.innerHTML = ''; this.data.items.forEach(i => { list.innerHTML += `<div class="bg-white p-4 rounded-3xl border border-slate-100 text-sm font-bold text-slate-700 flex justify-between mb-2"><span>${i.name}</span><span class="text-blue-600 font-black">₹${i.price || '-'}</span></div>`; }); },
            populateItemSuggestions: function() { const dl = document.getElementById('item-suggestions'); dl.innerHTML = ''; this.data.items.forEach(i => { dl.innerHTML += `<option value="${i.name}">`; }); },
            filterHistory: function(type) { ['btn-today', 'btn-month', 'btn-all'].forEach(id => document.getElementById(id).className = "flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-400"); document.getElementById('btn-'+type).className = "flex-1 py-2 text-xs font-bold rounded-lg transition-all filter-active"; const todayStr = new Date().toLocaleDateString('en-IN'); const now = new Date(); let filtered = []; if(type === 'today') filtered = this.data.invoices.filter(i => i.date === todayStr); else if(type === 'month') filtered = this.data.invoices.filter(i => { const d = new Date(i.rawDate || i.id); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); }); else filtered = this.data.invoices; document.getElementById('hist-total').innerText = filtered.reduce((sum, i) => sum + parseFloat(i.grandTotal), 0).toLocaleString('en-IN', {minimumFractionDigits: 2}); const list = document.getElementById('history-list'); list.innerHTML = ''; if(filtered.length===0) { list.innerHTML = '<div class="text-center text-slate-400 py-6 text-xs">No records</div>'; return; } filtered.forEach(i => { list.innerHTML += `<div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-3"><div class="flex justify-between items-start mb-3"><div><div class="flex items-center gap-2 mb-1"><h4 class="font-bold text-slate-800">${i.mode} Sale</h4><span class="badge-paid">PAID</span></div><h2 class="text-2xl font-black text-slate-900">₹ ${i.grandTotal}</h2><p class="text-[10px] text-slate-400 mt-1 font-bold">GST: ${i.gstPercent}%</p></div><div class="text-right"><div class="text-[10px] font-bold text-slate-400">#${i.no}</div><div class="text-[10px] text-slate-400 font-bold">${i.date}</div></div></div><div class="border-t border-slate-50 pt-3 flex justify-end gap-4 text-slate-400"><button onclick="app.currentInv=app.data.invoices.find(x=>x.id==${i.id});app.downloadBillAction()" class="hover:text-blue-600"><i class="fa-solid fa-download text-lg"></i></button><button onclick="app.currentInv=app.data.invoices.find(x=>x.id==${i.id});app.shareBillAction()" class="hover:text-green-600"><i class="fa-brands fa-whatsapp text-lg"></i></button><button onclick="app.deleteInvoice(${i.id})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash text-lg"></i></button></div></div>`; }); },
            deleteInvoice: function(id) { const item = this.data.invoices.find(i => i.id === id); if(confirm('Move to Trash?')) { this.moveToTrash(item, 'invoice'); this.data.invoices = this.data.invoices.filter(i => i.id !== id); this.save(); this.filterHistory('today'); this.renderSalesChart(); } },
            renderSalesChart: function() { const labels = [], data = [], today = new Date(); for(let i=6; i>=0; i--) { const d = new Date(today); d.setDate(today.getDate() - i); const dateStr = d.toLocaleDateString('en-IN'); labels.push(dateStr.slice(0, 5)); data.push(this.data.invoices.filter(inv => inv.date === dateStr).reduce((sum, inv) => sum + parseFloat(inv.grandTotal), 0)); } const ctx = document.getElementById('salesChart').getContext('2d'); if(salesChartInstance) salesChartInstance.destroy(); salesChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Sales', data, backgroundColor: '#3b82f6', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } }); },
            loadSettings: function() { document.getElementById('set-name').value = this.data.shop.shopName; document.getElementById('set-upi').value = this.data.shop.upi || ''; document.getElementById('set-phone').value = this.data.shop.phone; document.getElementById('set-address').value = this.data.shop.address; document.getElementById('set-gstin').value = this.data.shop.gstin || ''; document.getElementById('set-pass').value = this.data.shop.password || ''; },
            updateProfile: function() { this.data.shop.shopName = document.getElementById('set-name').value; this.data.shop.upi = document.getElementById('set-upi').value; this.data.shop.phone = document.getElementById('set-phone').value; this.data.shop.address = document.getElementById('set-address').value; this.data.shop.gstin = document.getElementById('set-gstin').value; this.data.shop.password = document.getElementById('set-pass').value; this.save(); alert('Profile Updated!'); },
            exportExcel: function() { const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.invoices), "Sales"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.expenses), "Expenses"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.items), "Stock"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(this.data.credits), "Credit_Book"); XLSX.writeFile(wb, `DigitMart_Report_${new Date().toISOString().slice(0,10)}.xlsx`); },
            backupFlow: function() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data)); a.download = `DigitMart_Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); },
            restore: function(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); if(file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) { reader.onload = function(e) { try { const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); if(wb.Sheets["Sales"]) app.data.invoices = XLSX.utils.sheet_to_json(wb.Sheets["Sales"]).reverse(); if(wb.Sheets["Expenses"]) app.data.expenses = XLSX.utils.sheet_to_json(wb.Sheets["Expenses"]); if(wb.Sheets["Stock"]) app.data.items = XLSX.utils.sheet_to_json(wb.Sheets["Stock"]); if(wb.Sheets["Credit_Book"]) app.data.credits = XLSX.utils.sheet_to_json(wb.Sheets["Credit_Book"]); app.save(); alert('Excel Restored!'); location.reload(); } catch(err) { alert('Error reading Excel'); } }; reader.readAsArrayBuffer(file); } else { reader.onload = function(e) { try { const d = JSON.parse(e.target.result); if(d.shop && d.invoices) { localStorage.setItem(DB_KEY, JSON.stringify(d)); alert('Restored!'); location.reload(); } } catch(err) { alert('Corrupt JSON'); } }; reader.readAsText(file); } },
            shareDigitTools: function() { const t = `Check out DigitPhone by DigitMart: https://digitsync.github.io/DigitPhone/`; window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, '_blank'); }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>


