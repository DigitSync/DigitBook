<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DigitMart BillBook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Thermal Print Styles */
        @media print {
            body * { visibility: hidden; }
            #receipt-preview, #receipt-preview * { visibility: visible; }
            #receipt-preview { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            @page { margin: 0; size: auto; }
        }

        .receipt-font { font-family: 'VT323', monospace; letter-spacing: 1px; }
        .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .fab-shadow { box-shadow: 0 4px 15px rgba(23, 114, 230, 0.4); }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 select-none bg-slate-100">

    <!-- LOGIN SCREEN -->
    <div id="view-login" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 hidden">
        <div class="w-20 h-20 bg-blue-700 rounded-xl flex items-center justify-center text-white text-3xl font-bold mb-4 shadow-lg">DM</div>
        <h1 class="text-2xl font-bold text-slate-800 mb-1">DigitMart</h1>
        <p class="text-slate-500 mb-8 text-sm">Business Management</p>
        <div class="w-full max-w-xs space-y-4">
            <div id="login-shop-display" class="text-center font-bold text-lg text-blue-700 hidden"></div>
            <input type="password" id="input-pass" placeholder="Password" class="w-full p-3 border border-slate-300 rounded-lg text-center text-lg outline-none focus:border-blue-600 bg-slate-50">
            <button onclick="app.login()" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-3 rounded-lg font-bold shadow-md active:scale-95 transition">OPEN</button>
        </div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="view-setup" class="fixed inset-0 z-50 bg-slate-100 flex flex-col items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl">
            <h2 class="text-xl font-bold mb-4 text-center text-slate-800">Setup Shop</h2>
            <form onsubmit="app.saveSetup(event)" class="space-y-3">
                <input name="shopName" placeholder="Shop Name" required class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="address" placeholder="Address" required class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="phone" placeholder="Phone No" required type="number" class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="upi" placeholder="UPI ID (e.g. 98xxx@ybl)" class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 font-semibold">
                <input name="password" placeholder="Set Password" required type="password" class="w-full p-3 border border-blue-200 rounded-lg bg-blue-50 outline-none focus:border-blue-500 font-bold">
                <button type="submit" class="w-full bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg mt-2">START</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="app-interface" class="flex-1 flex flex-col h-full hidden">
        
        <!-- HEADER (Blue like the image) -->
        <div class="bg-[#006699] px-4 py-3 shadow-md sticky top-0 z-30 flex justify-between items-center text-white">
            <div class="flex items-center gap-3">
                <button id="back-btn" onclick="app.nav('dashboard')" class="hidden w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h1 id="header-shop-name" class="font-bold text-lg tracking-wide">DigitMart</h1>
            </div>
            <div class="flex gap-4 text-white/90">
                <i class="fa-solid fa-bullhorn cursor-pointer"></i>
                <i class="fa-solid fa-bell cursor-pointer"></i>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <div class="flex-1 overflow-y-auto bg-slate-100 relative p-3" id="main-content">
            
            <!-- DASHBOARD (Grid Design) -->
            <div id="view-dashboard" class="space-y-4 pb-24 fade-in">
                
                <!-- Search Bar -->
                <div class="bg-white rounded-lg p-2 flex items-center shadow-sm border border-slate-200">
                    <i class="fa-solid fa-magnifying-glass text-slate-400 ml-2"></i>
                    <input type="text" placeholder="Search Transactions" class="w-full ml-3 outline-none text-sm text-slate-700">
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-[#e8f5e9] p-4 rounded-lg shadow-sm border border-green-100 flex flex-col justify-between h-24">
                        <span class="text-sm font-semibold text-slate-700">Total Sales</span>
                        <h2 class="text-xl font-bold text-green-600">₹ <span id="dash-total">0</span></h2>
                    </div>
                    <div class="bg-[#ffebee] p-4 rounded-lg shadow-sm border border-red-100 flex flex-col justify-between h-24">
                        <span class="text-sm font-semibold text-slate-700">My Expenses</span>
                        <h2 class="text-xl font-bold text-red-600">₹ <span id="dash-expense">0</span></h2>
                    </div>
                </div>

                <!-- Main Grid Buttons -->
                <div class="grid grid-cols-2 gap-3">
                    <!-- Sale List -->
                    <button onclick="app.nav('history')" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition h-32">
                        <i class="fa-solid fa-file-invoice text-3xl text-[#0088cc]"></i>
                        <span class="text-sm font-semibold text-slate-600">Sale List</span>
                    </button>
                    <!-- Stock Items -->
                    <button onclick="app.nav('items')" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition h-32">
                        <i class="fa-solid fa-cart-shopping text-3xl text-[#0088cc]"></i>
                        <span class="text-sm font-semibold text-slate-600">Items</span>
                    </button>
                    <!-- Expenses -->
                    <button onclick="app.nav('expenses')" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition h-32">
                        <i class="fa-solid fa-wallet text-3xl text-[#0088cc]"></i>
                        <span class="text-sm font-semibold text-slate-600">Expenses</span>
                    </button>
                    <!-- Settings -->
                    <button onclick="app.nav('settings')" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition h-32">
                        <i class="fa-solid fa-sliders text-3xl text-[#0088cc]"></i>
                        <span class="text-sm font-semibold text-slate-600">Settings</span>
                    </button>
                </div>
            </div>

            <!-- NEW SALE SCREEN (Simplified) -->
            <div id="view-billing" class="hidden h-full flex flex-col fade-in">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex-1 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <span class="text-xs font-bold text-slate-500">Invoice No</span>
                        <span class="font-mono font-bold text-slate-800" id="bill-inv-no">#INV-0000</span>
                    </div>

                    <!-- Customer Info (Optional) -->
                    <div class="mb-4">
                        <input id="bill-cust-phone" type="number" placeholder="Customer Phone (Optional)" class="w-full p-2 border-b border-slate-200 outline-none text-sm bg-transparent focus:border-blue-500 transition">
                    </div>

                    <!-- Main Input -->
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Add Item</label>
                            <input id="bill-item-name" list="item-suggestions" placeholder="Enter Item Name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none font-semibold text-slate-700">
                            <datalist id="item-suggestions"></datalist>
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Amount</label>
                            <input id="bill-amount" type="number" placeholder="₹ 0.00" class="w-full p-4 bg-blue-50 border border-blue-200 rounded-lg outline-none text-3xl font-bold text-blue-800" onkeyup="app.handleAmountChange()">
                        </div>

                        <!-- Payment Mode -->
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Payment Type</label>
                            <div class="grid grid-cols-3 gap-2 bg-slate-100 p-1 rounded-lg">
                                <button onclick="app.setMode('Cash')" id="mode-Cash" class="mode-btn py-2 rounded-md text-sm font-bold bg-white text-blue-700 shadow-sm transition">Cash</button>
                                <button onclick="app.setMode('UPI')" id="mode-UPI" class="mode-btn py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition">UPI</button>
                                <button onclick="app.setMode('Credit')" id="mode-Credit" class="mode-btn py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition">Credit</button>
                            </div>
                        </div>

                        <!-- QR Code Container -->
                        <div id="live-qr-container" class="hidden flex flex-col items-center justify-center p-4 bg-white border-2 border-dashed border-blue-200 rounded-xl">
                            <div id="live-qrcode"></div>
                            <p class="text-[10px] text-slate-400 mt-2">Ask Customer to Scan</p>
                        </div>
                    </div>
                </div>

                <!-- Bottom Buttons -->
                <div class="mt-4 grid grid-cols-2 gap-3 pb-16">
                    <button onclick="app.saveBill(true)" class="bg-slate-700 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition">
                        Save & New
                    </button>
                    <button onclick="app.saveBill(false)" class="bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition">
                        Save
                    </button>
                </div>
            </div>

            <!-- EXPENSES SCREEN -->
            <div id="view-expenses" class="hidden fade-in pb-20">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">Add Expense</h3>
                    <div class="flex gap-2 mb-2">
                        <input id="exp-name" placeholder="Name (e.g. Tea, Rent)" class="flex-1 p-2 border rounded-lg outline-none text-sm">
                        <input id="exp-amt" type="number" placeholder="₹ Amount" class="w-24 p-2 border rounded-lg outline-none text-sm font-bold">
                    </div>
                    <button onclick="app.addExpense()" class="w-full bg-red-500 text-white py-2 rounded-lg font-bold text-sm shadow-sm">Add Expense</button>
                </div>
                <div id="expense-list" class="space-y-2"></div>
            </div>

            <!-- ITEMS (STOCK) SCREEN -->
            <div id="view-items" class="hidden fade-in pb-20">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">Add Stock Item</h3>
                    <div class="flex gap-2">
                        <input id="stock-name" placeholder="Item Name" class="flex-1 p-2 border rounded-lg outline-none text-sm">
                        <button onclick="app.addStockItem()" class="bg-blue-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm">Add</button>
                    </div>
                </div>
                <div id="stock-list" class="space-y-2"></div>
            </div>

            <!-- HISTORY / SALE LIST -->
            <div id="view-history" class="hidden pb-20 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-slate-700">All Sales</h2>
                    <button onclick="app.exportCSV()" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded border border-green-200 font-bold">Export</button>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>

            <!-- SETTINGS -->
            <div id="view-settings" class="hidden pb-20 fade-in">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 space-y-4">
                    <h2 class="font-bold border-b pb-2">Settings</h2>
                    <input id="set-name" placeholder="Shop Name" class="w-full p-2 border rounded outline-none text-sm">
                    <input id="set-upi" placeholder="UPI ID" class="w-full p-2 border rounded outline-none text-sm">
                    <input id="set-phone" placeholder="Phone" class="w-full p-2 border rounded outline-none text-sm">
                    <input id="set-address" placeholder="Address" class="w-full p-2 border rounded outline-none text-sm">
                    <button onclick="app.updateProfile()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold shadow">Update</button>
                    <button onclick="app.backupFlow()" class="w-full bg-slate-100 text-slate-700 py-2 rounded-lg font-bold border border-slate-200 mt-2">Backup Data</button>
                    <button onclick="app.logout()" class="w-full text-red-500 py-2 font-bold text-xs">Logout</button>
                </div>
            </div>

        </div>

        <!-- FAB (Add Button) -->
        <div id="fab-btn" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-40">
            <button onclick="app.newBill()" class="w-14 h-14 bg-[#0088cc] rounded-full text-white text-2xl shadow-xl fab-shadow flex items-center justify-center border-4 border-white active:scale-90 transition">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

    </div>

    <!-- RECEIPT MODAL -->
    <div id="success-modal" class="fixed inset-0 z-[60] bg-black/80 flex flex-col items-center justify-center p-4 hidden">
        <div id="receipt-preview" class="bg-white w-[300px] p-4 text-center mb-4 rounded-sm shadow-2xl relative">
            <h2 id="r-shop" class="text-lg font-bold uppercase border-b-2 border-dashed border-black pb-2 mb-2">SHOP NAME</h2>
            <div class="text-left text-[11px] font-mono mb-2">
                <p>Inv: <span id="r-inv"></span></p>
                <p>Date: <span id="r-date"></span></p>
                <p>Cust: <span id="r-cust"></span></p>
            </div>
            <table class="w-full text-[12px] font-mono font-bold mb-2 border-b-2 border-dashed border-black pb-2">
                <tr><td class="text-left" id="r-item-name">Item</td><td class="text-right" id="r-item-amt">0.00</td></tr>
            </table>
            <div class="flex justify-between font-bold text-lg border-b-2 border-dashed border-black pb-2 mb-2">
                <span>TOTAL</span>
                <span>₹<span id="r-total">0</span></span>
            </div>
            <div id="final-qr" class="flex justify-center my-2"></div>
            <p class="text-[9px] mt-2">Powered by DigitMart</p>
        </div>
        <div class="flex gap-3">
            <button onclick="app.shareBill()" class="bg-green-500 text-white p-3 rounded-full shadow-lg"><i class="fa-brands fa-whatsapp text-xl"></i></button>
            <button onclick="window.print()" class="bg-blue-500 text-white p-3 rounded-full shadow-lg"><i class="fa-solid fa-print text-xl"></i></button>
            <button onclick="document.getElementById('success-modal').classList.add('hidden')" class="bg-slate-500 text-white p-3 rounded-full shadow-lg"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
    </div>

    <script>
        const DB_KEY = 'digitmart_billbook_v4'; 

        const app = {
            data: { shop: null, invoices: [], expenses: [], items: [] },
            currentMode: 'Cash',
            currentInv: null,

            init: function() {
                const stored = localStorage.getItem(DB_KEY);
                if(stored) this.data = JSON.parse(stored);
                
                if(this.data.shop) {
                    document.getElementById('view-login').classList.remove('hidden');
                    document.getElementById('login-shop-display').innerText = this.data.shop.shopName;
                    document.getElementById('login-shop-display').classList.remove('hidden');
                } else {
                    document.getElementById('view-setup').classList.remove('hidden');
                }
            },

            save: function() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                this.updateDashboard();
            },

            saveSetup: function(e) {
                e.preventDefault();
                const fd = new FormData(e.target);
                this.data.shop = Object.fromEntries(fd.entries());
                this.save();
                location.reload();
            },

            login: function() {
                if(document.getElementById('input-pass').value === this.data.shop.password) {
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('app-interface').classList.remove('hidden');
                    this.loadSettings();
                    this.nav('dashboard');
                } else alert('Wrong Password');
            },

            logout: function() { location.reload(); },

            nav: function(viewId) {
                document.querySelectorAll('#main-content > div').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + viewId).classList.remove('hidden');
                document.getElementById('header-shop-name').innerText = this.data.shop.shopName;
                
                const fab = document.getElementById('fab-btn');
                const backBtn = document.getElementById('back-btn');

                if(viewId === 'dashboard') {
                    fab.classList.remove('hidden');
                    backBtn.classList.add('hidden');
                    this.updateDashboard();
                } else {
                    fab.classList.add('hidden');
                    backBtn.classList.remove('hidden');
                }

                if(viewId === 'billing') {
                    document.getElementById('bill-inv-no').innerText = `INV-${String(this.data.invoices.length + 1).padStart(4, '0')}`;
                    this.populateItemSuggestions();
                }
                if(viewId === 'history') this.renderHistory();
                if(viewId === 'expenses') this.renderExpenses();
                if(viewId === 'items') this.renderStockItems();
            },

            updateDashboard: function() {
                const totalSale = this.data.invoices.reduce((sum, i) => sum + parseFloat(i.amount), 0);
                const totalExp = this.data.expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
                document.getElementById('dash-total').innerText = totalSale.toLocaleString('en-IN');
                document.getElementById('dash-expense').innerText = totalExp.toLocaleString('en-IN');
            },

            // --- BILLING LOGIC ---
            newBill: function() {
                this.currentMode = 'Cash';
                this.updateModeUI();
                document.getElementById('bill-item-name').value = '';
                document.getElementById('bill-amount').value = '';
                document.getElementById('bill-cust-phone').value = '';
                document.getElementById('live-qr-container').classList.add('hidden');
                this.nav('billing');
            },

            setMode: function(mode) {
                this.currentMode = mode;
                this.updateModeUI();
                this.handleAmountChange(); // Regen QR if needed
            },

            updateModeUI: function() {
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.className = "mode-btn py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition";
                });
                const active = document.getElementById('mode-' + this.currentMode);
                active.className = "mode-btn py-2 rounded-md text-sm font-bold bg-white text-blue-700 shadow-sm transition ring-1 ring-blue-100";
            },

            handleAmountChange: function() {
                const amt = parseFloat(document.getElementById('bill-amount').value) || 0;
                const qrCont = document.getElementById('live-qr-container');
                const qrDiv = document.getElementById('live-qrcode');
                
                if(this.currentMode === 'UPI' && amt > 0 && this.data.shop.upi) {
                    qrCont.classList.remove('hidden');
                    qrDiv.innerHTML = '';
                    const link = `upi://pay?pa=${this.data.shop.upi}&pn=${encodeURIComponent(this.data.shop.shopName)}&am=${amt}&cu=INR`;
                    new QRCode(qrDiv, { text: link, width: 120, height: 120 });
                } else {
                    qrCont.classList.add('hidden');
                }
            },

            saveBill: function(isNew) {
                const amt = parseFloat(document.getElementById('bill-amount').value);
                if(!amt || amt <= 0) return alert('Boss, Amount to likho!');
                
                const itemName = document.getElementById('bill-item-name').value || 'Sale';
                const custPhone = document.getElementById('bill-cust-phone').value;

                const inv = {
                    id: Date.now(),
                    no: `INV-${String(this.data.invoices.length + 1).padStart(4, '0')}`,
                    date: new Date().toLocaleDateString('en-IN'),
                    time: new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}),
                    item: itemName,
                    amount: amt,
                    mode: this.currentMode,
                    phone: custPhone
                };

                this.data.invoices.unshift(inv);
                this.save();
                this.currentInv = inv;

                if(isNew) {
                    // Flash success and reset
                    const btn = event.target;
                    const originalText = btn.innerText;
                    btn.innerText = "Saved!";
                    btn.classList.replace('bg-slate-700', 'bg-green-600');
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.classList.replace('bg-green-600', 'bg-slate-700');
                        this.newBill();
                    }, 800);
                } else {
                    this.showReceipt(inv);
                }
            },

            showReceipt: function(inv) {
                document.getElementById('r-shop').innerText = this.data.shop.shopName;
                document.getElementById('r-inv').innerText = inv.no;
                document.getElementById('r-date').innerText = inv.date + ' ' + inv.time;
                document.getElementById('r-cust').innerText = inv.phone || 'Guest';
                document.getElementById('r-item-name').innerText = inv.item;
                document.getElementById('r-item-amt').innerText = inv.amount.toFixed(2);
                document.getElementById('r-total').innerText = inv.amount.toFixed(2);
                
                const qrDiv = document.getElementById('final-qr');
                qrDiv.innerHTML = '';
                if(this.data.shop.upi) {
                    new QRCode(qrDiv, { text: `upi://pay?pa=${this.data.shop.upi}&pn=${this.data.shop.shopName}&am=${inv.amount}`, width: 80, height: 80 });
                }
                
                document.getElementById('success-modal').classList.remove('hidden');
            },

            shareBill: function() {
                if(!this.currentInv || !this.currentInv.phone) return alert('No Phone Number!');
                const text = `Bill from ${this.data.shop.shopName}\nInv: ${this.currentInv.no}\nAmt: ₹${this.currentInv.amount}\nMode: ${this.currentInv.mode}`;
                window.open(`https://wa.me/91${this.currentInv.phone}?text=${encodeURIComponent(text)}`, '_blank');
            },

            // --- EXPENSES ---
            addExpense: function() {
                const name = document.getElementById('exp-name').value;
                const amt = parseFloat(document.getElementById('exp-amt').value);
                if(!name || !amt) return;
                this.data.expenses.unshift({ id: Date.now(), name, amount: amt, date: new Date().toLocaleDateString('en-IN') });
                this.save();
                document.getElementById('exp-name').value = '';
                document.getElementById('exp-amt').value = '';
                this.renderExpenses();
            },

            renderExpenses: function() {
                const list = document.getElementById('expense-list');
                list.innerHTML = '';
                this.data.expenses.forEach(e => {
                    list.innerHTML += `<div class="bg-white p-3 rounded-lg border flex justify-between"><span class="text-sm font-semibold">${e.name} <span class="text-xs text-slate-400">(${e.date})</span></span><span class="font-bold text-red-500">₹${e.amount}</span></div>`;
                });
            },

            // --- ITEMS / STOCK ---
            addStockItem: function() {
                const name = document.getElementById('stock-name').value;
                if(!name) return;
                this.data.items.push(name);
                this.save();
                document.getElementById('stock-name').value = '';
                this.renderStockItems();
            },

            renderStockItems: function() {
                const list = document.getElementById('stock-list');
                list.innerHTML = '';
                this.data.items.forEach(i => {
                    list.innerHTML += `<div class="bg-white p-3 rounded-lg border text-sm font-semibold text-slate-700">${i}</div>`;
                });
            },
            
            populateItemSuggestions: function() {
                const dl = document.getElementById('item-suggestions');
                dl.innerHTML = '';
                this.data.items.forEach(i => {
                    dl.innerHTML += `<option value="${i}">`;
                });
            },

            // --- HISTORY ---
            renderHistory: function() {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                this.data.invoices.forEach(i => {
                    list.innerHTML += `
                        <div class="bg-white p-3 rounded-lg border flex justify-between items-center" onclick="app.currentInv=this.data.invoices.find(x=>x.id==${i.id});app.showReceipt(app.currentInv)">
                            <div>
                                <div class="font-bold text-slate-700 text-sm">${i.item}</div>
                                <div class="text-[10px] text-slate-400">${i.no} • ${i.date}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-green-600">₹${i.amount}</div>
                                <div class="text-[10px] uppercase font-bold text-slate-400">${i.mode}</div>
                            </div>
                        </div>`;
                });
            },

            loadSettings: function() {
                document.getElementById('set-name').value = this.data.shop.shopName;
                document.getElementById('set-upi').value = this.data.shop.upi || '';
                document.getElementById('set-phone').value = this.data.shop.phone;
                document.getElementById('set-address').value = this.data.shop.address;
            },
            
            updateProfile: function() {
                this.data.shop.shopName = document.getElementById('set-name').value;
                this.data.shop.upi = document.getElementById('set-upi').value;
                this.data.shop.phone = document.getElementById('set-phone').value;
                this.data.shop.address = document.getElementById('set-address').value;
                this.save();
                alert('Updated!');
            },

            backupFlow: function() {
                const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
                const a = document.createElement('a');
                a.href = data;
                a.download = `Backup_${new Date().getTime()}.json`;
                document.body.appendChild(a);
                a.click();
            },
            
            exportCSV: function() {
                let csv = "Inv,Date,Item,Amount,Mode\n";
                this.data.invoices.forEach(i => csv += `${i.no},${i.date},${i.item},${i.amount},${i.mode}\n`);
                const a = document.createElement('a');
                a.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
                a.download = "Sales.csv";
                a.click();
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
